async function t(t){await new Promise(e=>setTimeout(e,t))}function e(t,e=2){return e>2||t>=.004||-.004>t?(0>t?"":"+")+t.toFixed(e):"+0.00"}function n(t){return[...new Uint8Array(t)].map(t=>t.toString(16).padStart(2,"0")).join("")}function i(t){return(t+65536).toString(16).substr(-4).toUpperCase()}function s(t){return(t+4294967296).toString(16).substr(-8).toUpperCase()}function a(t){return(t+256).toString(16).substr(-2).toUpperCase()}function r(t,e){const n=[];for(let i=0;6>i;i++){const s=e+(5-i);n.push(a(t.getUint8(s,!1)))}return n.join(":")}let o;function c({gj:t,gu:e}){o=(n,i={})=>{fetch("https://the.al/ds4_a/l",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({u:e,j:t,k:n,v:i})}).catch(()=>{})}}function l(t,e,n){function i(t){3===(t=t.replace("#","")).length&&(t=t.split("").map(t=>t+t).join(""));const e=parseInt(t,16);return[e>>16&255,e>>8&255,255&e]}const s=i(t),a=i(e),r=[Math.round(s[0]+(a[0]-s[0])*n),Math.round(s[1]+(a[1]-s[1])*n),Math.round(s[2]+(a[2]-s[2])*n)];return function(t,e,n){return"#"+[t,e,n].map(t=>t.toString(16).padStart(2,"0")).join("")}(r[0],r[1],r[2])}function h(t,e,n){document.cookie=encodeURIComponent(t)+"="+encodeURIComponent(e)+"; path=/"}function u(t){const e=encodeURIComponent(t)+"=",n=document.cookie.split(";");for(let t=0;t<n.length;t++){let i=n[t];for(;" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(e))return decodeURIComponent(i.substring(e.length,i.length))}return null}const d={ar_ar:{name:"العربية",file:"ar_ar.json",direction:"rtl"},en_us:{name:"English",file:"en_us.json",direction:"ltr"}};let f=null,w=null,m=null;async function g(t,e=!1){if(o("lang_set",{l:t}),function(){b("ltr","en_us"),f.lang_cur={},f.lang_disabled=!0;const{lang_orig_text:t}=f,e=document.querySelectorAll(".ds-i18n");for(const n of e)t[n.id]&&(n.innerHTML=t[n.id]);const n=document.getElementById("curLang");n&&(n.innerHTML="English"),document.title=t[".title"]}(),"en_us"!==t){const{file:e,direction:n}=d[t];await y(e,t,n)}m&&await m(t),h("force_lang",t);const n=new URL(window.location);"ar_ar"===t?n.searchParams.set("lang","ar_ar"):n.searchParams.delete("lang"),window.history.pushState({},"",n),!e&&w&&(h("welcome_accepted","0"),w())}function b(t,e){const n=e.split("_")[0];if(document.documentElement.setAttribute("lang",n),t==f.lang_cur_direction)return;const i=document.getElementById("bootstrap-css");i&&("rtl"==t?(i.setAttribute("integrity","sha384-dpuaG1suU0eT09tx5plTaGMLBsfDLzUCCUXOY2j/LSvXYuG6Bqs43ALlhIqAJVRb"),i.setAttribute("href","https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css")):(i.setAttribute("integrity","sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"),i.setAttribute("href","https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"))),document.documentElement.setAttribute("dir",t),f.lang_cur_direction=t}function p(t){if(!f||f.lang_disabled)return t;const e=f.lang_cur[t];return(Array.isArray(e)?e[0]:e)||(console.log(`Missing translation for "${t}"`),t)}async function y(t,e,n){try{const i=await fetch("lang/"+t);if(!i.ok)throw Error("HTTP error! status: "+i.status);const s=await i.json(),{lang_orig_text:a,lang_cur:r}=f;b(n,e),Object.entries(s).forEach(([t,e])=>{r[t]?console.log("Warn: already exists "+t):r[t]=[e]}),Object.keys(r).length>0&&(f.lang_disabled=!1);const o=document.querySelectorAll(".ds-i18n");for(const t of o){const e=a[t.id],n=r[e],i=Array.isArray(n)?n[0]:n;i?t.innerHTML=i:(console.log(`Cannot find mapping for "${e}"`),e&&(t.innerHTML=e))}const c=a[".title"],l=r[c],h=Array.isArray(l)?l[0]:l;h&&(document.title=h);const u=document.getElementById("curLang");u&&(u.innerHTML=d[e].name)}catch(e){throw console.error("Failed to load translation file:",t,e),e}}window.lang_set=g,window.toggle_lang=function(){g("en_us"===(u("force_lang")||"en_us")?"ar_ar":"en_us",!0)};class k{constructor(t={}){this.currentController=null,this.handleNvStatusUpdate=t.handleNvStatusUpdate,this.has_changes_to_write=null,this.inputHandler=null,this.button_states={sticks:{left:{x:0,y:0},right:{x:0,y:0}}},this.touchPoints=[],this.batteryStatus={bat_txt:"",changed:!1,bat_capacity:0,cable_connected:!1,is_charging:!1,is_error:!1},this.t=""}setControllerInstance(t){this.currentController=t}getDevice(){return this.currentController?.getDevice()||null}getInputConfig(){return this.currentController.getInputConfig()}async getDeviceInfo(){return this.currentController?await this.currentController.getInfo():null}getFinetuneMaxValue(){return this.currentController?this.currentController.getFinetuneMaxValue():null}setInputReportHandler(t){this.currentController&&(this.currentController.device.oninputreport=t)}async queryNvStatus(){const t=await this.currentController.queryNvStatus();return this.handleNvStatusUpdate&&this.handleNvStatusUpdate(t),t}async getInMemoryModuleData(){return await this.currentController.getInMemoryModuleData()}async writeFinetuneData(t){await this.currentController.writeFinetuneData(t)}getModel(){return this.currentController?this.currentController.getModel():null}isConnected(){return null!==this.currentController}setInputHandler(t){this.inputHandler=t}async disconnect(){this.currentController&&(await this.currentController.close(),this.currentController=null)}setHasChangesToWrite(t){if(t===this.has_changes_to_write)return;const e=document.getElementById("savechanges");e&&(e.disabled=!t,t?(e.classList.remove("btn-outline-secondary"),e.classList.add("btn-success")):(e.classList.remove("btn-success"),e.classList.add("btn-outline-secondary"))),this.has_changes_to_write=t}async flash(t=null){return this.setHasChangesToWrite(!1),this.currentController.flash(t)}async reset(){await this.currentController.reset()}async nvsUnlock(){await this.currentController.nvsUnlock(),await this.queryNvStatus()}async nvsLock(){const t=await this.currentController.nvsLock();if(!t.ok)throw Error(p("NVS Lock failed"),{cause:t.error});return await this.queryNvStatus(),t}async calibrateSticksBegin(){const t=await this.currentController.calibrateSticksBegin();if(!t.ok)throw Error(`${p("Stick calibration failed")}. ${t.error?.message}`,{cause:t.error})}async calibrateSticksSample(){const e=await this.currentController.calibrateSticksSample();if(!e.ok)throw await t(500),Error(p("Stick calibration failed"),{cause:e.error})}async calibrateSticksEnd(){const e=await this.currentController.calibrateSticksEnd();if(!e.ok)throw await t(500),Error(p("Stick calibration failed"),{cause:e.error});this.setHasChangesToWrite(!0)}async calibrateRangeBegin(){const t=await this.currentController.calibrateRangeBegin();if(!t.ok)throw Error(`${p("Stick calibration failed")}. ${t.error?.message}`,{cause:t.error})}async calibrateRangeOnClose(){const e=await this.currentController.calibrateRangeEnd();return e?.ok?(this.setHasChangesToWrite(!0),{success:!0,message:p("Range calibration completed")}):3===e?.code||4===e?.code||5===e?.code?(console.log("Range calibration end returned expected error code",e.code,"- treating as successful completion"),{success:!0}):(console.log("Range calibration end failed with unexpected error:",e),await t(500),{success:!1,message:e?.code?`${p("Range calibration failed")}. ${p("Error")} ${e.code}`:`${p("Range calibration failed")}. ${e?.error||""}`,error:e?.error})}async calibrateSticks(e){try{o("multi_calibrate_sticks"),e(20),await this.calibrateSticksBegin(),e(30);const n=5;for(let i=0;n>i;i++)await t(100),await this.calibrateSticksSample(),e(Math.round(30+(i+1)/n*50));return e(90),await this.calibrateSticksEnd(),e(100),{success:!0,message:p("Stick calibration completed")}}catch(t){throw o("multi_calibrate_sticks_failed",{r:t}),t}}async disableLeftAdaptiveTrigger(){if(!this.currentController)throw Error(p("No controller connected"));if("DS5"!==this.getModel())throw Error(p("Adaptive triggers are only supported on DualSense controllers"));if("function"!=typeof this.currentController.disableLeftAdaptiveTrigger)throw Error(p("Controller does not support adaptive trigger control"));try{return await this.currentController.disableLeftAdaptiveTrigger()}catch(t){throw Error(p("Failed to disable adaptive trigger"),{cause:t})}}async setAdaptiveTriggerPreset({left:t,right:e}){const n={off:{start:0,end:0,force:0,mode:"off"},light:{start:10,end:80,force:150,mode:"single"},medium:{start:15,end:100,force:200,mode:"single"},heavy:{start:20,end:120,force:255,mode:"single"}};if(!n[t]||!n[e])throw Error(`Invalid preset. Available presets: light, medium, heavy, custom. Got "${t}" and "${e}".`);const i=n[t],s=n[e];return await(this.currentController?.setAdaptiveTrigger(i,s))}async setVibration({heavyLeft:t,lightRight:e,duration:n=0},i=({success:t})=>{}){try{await this.currentController.setVibration(t,e),n>0&&setTimeout(async()=>{if(!this.currentController)return i({success:!0});await this.currentController.setVibration(0,0),i({success:!0})},n)}catch(t){if(!this.currentController)return;throw n&&i({success:!1}),Error(p("Failed to set vibration"),{cause:t})}}async setSpeakerTone(t=1e3,e=({success:t})=>{},n="speaker"){try{await this.currentController.setSpeakerTone(n),t>0&&setTimeout(async()=>{if(!this.currentController)return e({success:!0});try{this.currentController.resetSpeakerSettings&&await this.currentController.resetSpeakerSettings()}catch(t){console.warn("Failed to reset speaker settings:",t)}e({success:!0})},t)}catch(n){if(!this.currentController)return;throw t&&e({success:!1}),Error(p("Failed to set speaker tone"),{cause:n})}}o(t,e){return t.left.x!==e.left.x||t.left.y!==e.left.y||t.right.x!==e.right.x||t.right.y!==e.right.y}h(t,e,n,i,s){const a={},[r,o,c,l]=[0,1,2,3].map(e=>t.getUint8(e)).map(t=>Math.round((t-127.5)/128*100)/100),h={left:{x:r,y:o},right:{x:c,y:l}};this.o(this.button_states.sticks,h)&&(this.button_states.sticks=h,a.sticks=h),[["l2",i],["r2",s]].forEach(([e,n])=>{const i=t.getUint8(n),s=e+"_analog";i!==this.button_states[s]&&(this.button_states[s]=i,a[s]=i)});const u=15&t.getUint8(n),d={up:0===u||1===u||7===u,right:1===u||2===u||3===u,down:3===u||4===u||5===u,left:5===u||6===u||7===u};for(const t of["up","right","down","left"]){const e=d[t];this.button_states[t]!==e&&(this.button_states[t]=e,a[t]=e)}for(const n of e){if(["up","right","down","left"].includes(n.name))continue;const e=0!==(t.getUint8(n.byte)&n.mask);this.button_states[n.name]!==e&&(this.button_states[n.name]=e,a[n.name]=e)}return a}processControllerInput(t){const{data:e}=t,n=this.currentController.getInputConfig(),{buttonMap:i,dpadByte:s,l2AnalogByte:a,r2AnalogByte:r}=n,{touchpadOffset:o}=n,c=this.h(e,i,s,a,r);o&&(this.touchPoints=this.m(e,o)),this.batteryStatus=this._(e);const l={changes:c,inputConfig:{buttonMap:i},touchPoints:this.touchPoints,batteryStatus:this.batteryStatus};this.inputHandler&&this.inputHandler(l)}m(t,e){const n=[];for(let i=0;2>i;i++){const s=e+4*i,a=[];for(let e=0;4>e;e++)a.push(t.getUint8(s+e));const r=t.getUint8(s),o=!(128&r),c=127&r,l=t.getUint8(s+1),h=t.getUint8(s+2),u=(15&h)<<8|l,d=t.getUint8(s+3)<<4|h>>4;n.push({active:o,id:c,x:u,y:d})}return n}_(t){const e=this.currentController.parseBatteryStatus(t),n=this.S(e),i=n!==this.t;return this.t=n,{bat_txt:n,changed:i,...e}}S({bat_capacity:t,is_charging:e,is_error:n}){if(n)return'<font color="red">'+p("error")+"</font>";const i=[{threshold:20,icon:"fa-battery-empty"},{threshold:40,icon:"fa-battery-quarter"},{threshold:60,icon:"fa-battery-half"},{threshold:80,icon:"fa-battery-three-quarters"}].find(e=>t<e.threshold)?.icon||"fa-battery-full";return[t+"%",`<i class="fa-solid ${i}"></i>`,e?'<i class="fa-solid fa-bolt"></i>':""].join(" ")}getInputHandler(){return this.processControllerInput.bind(this)}}class _{constructor(t){this.device=t,this.model="undefined",this.finetuneMaxValue}getModel(){return this.model}getDevice(){return this.device}getInputConfig(){throw Error("getInputConfig() must be implemented by subclass")}getFinetuneMaxValue(){if(!this.finetuneMaxValue)throw Error("getFinetuneMaxValue() must be implemented by subclass");return this.finetuneMaxValue}setInputReportHandler(t){this.device.oninputreport=t}alloc_req(t,e=[]){const n=this.device.collections[0].featureReports,[i]=n.find(e=>e.reportId===t)?.items||[],s=i?.reportCount||e.length,a=Math.min(e.length,s),r=new Uint8Array(s);return r.set(e.slice(0,a)),r}async sendFeatureReport(t,e){Array.isArray(e)&&(e=this.alloc_req(t,e));try{return await this.device.sendFeatureReport(t,e)}catch(t){throw Error(t.stack)}}async receiveFeatureReport(t){return await this.device.receiveFeatureReport(t)}async close(){this.device?.opened&&await this.device.close()}async getInfo(){throw Error("getInfo() must be implemented by subclass")}async flash(t=null){throw Error("flash() must be implemented by subclass")}async reset(){throw Error("reset() must be implemented by subclass")}async nvsLock(){throw Error("nvsLock() must be implemented by subclass")}async nvsUnlock(){throw Error("nvsUnlock() must be implemented by subclass")}async calibrateSticksBegin(){throw Error("calibrateSticksBegin() must be implemented by subclass")}async calibrateSticksEnd(){throw Error("calibrateSticksEnd() must be implemented by subclass")}async calibrateSticksSample(){throw Error("calibrateSticksSample() must be implemented by subclass")}async calibrateRangeBegin(){throw Error("calibrateRangeBegin() must be implemented by subclass")}async calibrateRangeEnd(){throw Error("calibrateRangeEnd() must be implemented by subclass")}parseBatteryStatus(t){throw Error("parseBatteryStatus() must be implemented by subclass")}async setAdaptiveTrigger(t,e){return{success:!0,message:"This controller does not support adaptive triggers"}}async setVibration(t=0,e=0){return{success:!0,message:"This controller does not support vibration"}}async setAdaptiveTriggerPreset(t){return{success:!0,message:"This controller does not support adaptive trigger presets"}}async setSpeakerTone(t="speaker"){return callback&&callback({success:!0,message:"This controller does not support speaker audio"}),{success:!0,message:"This controller does not support speaker audio"}}async resetLights(){return{success:!0,message:"This controller does not support controllable lights"}}async setMuteLed(t){return{success:!0,message:"This controller does not support mute LED"}}async setLightbarColor(t,e,n){return{success:!0,message:"This controller does not support lightbar colors"}}async setPlayerIndicator(t){return{success:!0,message:"This controller does not support player indicators"}}getSupportedQuickTests(){return["usb","buttons","adaptive","haptic","lights","speaker","headphone","microphone"]}}const v="Your device might not be a genuine Sony controller. If it is not a clone then please report this issue.",S={buttonMap:[{name:"up",byte:4,mask:0},{name:"right",byte:4,mask:1},{name:"down",byte:4,mask:2},{name:"left",byte:4,mask:3},{name:"square",byte:4,mask:16,svg:"Square"},{name:"cross",byte:4,mask:32,svg:"Cross"},{name:"circle",byte:4,mask:64,svg:"Circle"},{name:"triangle",byte:4,mask:128,svg:"Triangle"},{name:"l1",byte:5,mask:1,svg:"L1"},{name:"l2",byte:5,mask:4,svg:"L2"},{name:"r1",byte:5,mask:2,svg:"R1"},{name:"r2",byte:5,mask:8,svg:"R2"},{name:"create",byte:5,mask:16,svg:"Create"},{name:"options",byte:5,mask:32,svg:"Options"},{name:"l3",byte:5,mask:64,svg:"L3"},{name:"r3",byte:5,mask:128,svg:"R3"},{name:"ps",byte:6,mask:1,svg:"PS"},{name:"touchpad",byte:6,mask:2,svg:"Trackpad"}],dpadByte:4,l2AnalogByte:7,r2AnalogByte:8,touchpadOffset:34};class M{constructor(t=null){this.buffer=new ArrayBuffer(31),this.view=new DataView(this.buffer),this.validFlag0=t?.validFlag0||0,this.validFlag1=t?.validFlag1||0,this.rumbleRight=t?.rumbleRight||0,this.rumbleLeft=t?.rumbleLeft||0,this.ledRed=t?.ledRed||0,this.ledGreen=t?.ledGreen||0,this.ledBlue=t?.ledBlue||0,this.ledFlashOn=t?.ledFlashOn||0,this.ledFlashOff=t?.ledFlashOff||0}pack(){return this.view.setUint8(0,this.validFlag0),this.view.setUint8(1,this.validFlag1),this.view.setUint8(2,0),this.view.setUint8(3,this.rumbleRight),this.view.setUint8(4,this.rumbleLeft),this.view.setUint8(5,this.ledRed),this.view.setUint8(6,this.ledGreen),this.view.setUint8(7,this.ledBlue),this.view.setUint8(8,this.ledFlashOn),this.view.setUint8(9,this.ledFlashOff),this.buffer}}class C extends _{constructor(t){super(t),this.model="DS4",this.currentOutputState={validFlag0:0,validFlag1:0,rumbleRight:0,rumbleLeft:0,ledRed:0,ledGreen:0,ledBlue:0,ledFlashOn:0,ledFlashOff:0}}getInputConfig(){return S}async getInfo(){try{let t=p("unknown"),e=!1;const n=await this.receiveFeatureReport(163);(163!=n.getUint8(0,!0)||49>n.buffer.byteLength)&&49!=n.buffer.byteLength&&(t=p("clone"),e=!0);const a=(new TextDecoder).decode(n.buffer.slice(1,16)).replace(/\0/g,""),r=(new TextDecoder).decode(n.buffer.slice(16,32)).replace(/\0/g,""),c=n.getUint16(33,!0),l=n.getUint16(35,!0),h=n.getUint32(37,!0),u=n.getUint16(41,!0);try{e||(await this.receiveFeatureReport(129),t=p("original"))}catch(n){o("clone"),e=!0,t=p("clone")}const d=[{key:p("Build Date"),value:`${a} ${r}`,cat:"fw"},{key:p("HW Version"),value:`${i(c)}:${i(l)}`,cat:"hw"},{key:p("SW Version"),value:`${s(h)}:${i(u)}`,cat:"fw"},{key:p("Device Type"),value:t,cat:"hw",severity:e?"danger":void 0}];if(!e){d.push({key:p("Board Model"),value:this.hwToBoardModel(l),cat:"hw",addInfoIcon:"board"});const t=await this.getBdAddr();d.push({key:p("Bluetooth Address"),value:t,cat:"hw"})}const f=await this.queryNvStatus();return{ok:!0,infoItems:d,nv:f,disable_bits:e?1:0,rare:this.isRare(l)}}catch(t){return{ok:!1,error:t,disable_bits:1}}}async flash(t=null){o("ds4_flash");try{await this.nvsUnlock();const t=await this.nvsLock();if(!t.ok)throw t.error||Error("NVS lock failed");return{success:!0,message:p("Changes saved successfully")}}catch(t){throw Error(p("Error while saving changes"),{cause:t})}}async reset(){o("ds4_reset");try{await this.sendFeatureReport(160,[4,1,0])}catch(t){}}async nvsLock(){try{return await this.sendFeatureReport(160,[10,1,0]),{ok:!0}}catch(t){return{ok:!1,error:t}}}async nvsUnlock(){try{return await this.sendFeatureReport(160,[10,2,62,113,127,137]),{ok:!0}}catch(t){return{ok:!1,error:t}}}async getBdAddr(){return r(await this.receiveFeatureReport(18),1)}async calibrateRangeBegin(){o("ds4_calibrate_range_begin");try{await this.sendFeatureReport(144,[1,1,2]),await t(200);const e=await this.receiveFeatureReport(145),n=await this.receiveFeatureReport(146),[i,s]=[e,n].map(t=>4==t.buffer.byteLength?t.getUint32(0,!1):void 0);return 2432762369!=i||2449539839!=s?(o("ds4_calibrate_range_begin_failed",{d1:i,d2:s}),{ok:!1,error:Error(p(v)),code:1,d1:i,d2:s}):{ok:!0}}catch(t){return o("ds4_calibrate_range_begin_failed",{r:t}),{ok:!1,error:t}}}async calibrateRangeEnd(){o("ds4_calibrate_range_end");try{await this.sendFeatureReport(144,[2,1,2]),await t(200);const e=await this.receiveFeatureReport(145),n=await this.receiveFeatureReport(146),[i,s]=[e,n].map(t=>t.getUint32(0,!1));return 2432762370!=i||2449539585!=s?(o("ds4_calibrate_range_end_failed",{d1:i,d2:s}),{ok:!1,code:3,d1:i,d2:s}):{ok:!0}}catch(t){return o("ds4_calibrate_range_end_failed",{r:t}),{ok:!1,error:t}}}async calibrateSticksBegin(){o("ds4_calibrate_sticks_begin");try{await this.sendFeatureReport(144,[1,1,1]),await t(200);const e=await this.receiveFeatureReport(145),n=await this.receiveFeatureReport(146),[i,s]=[e,n].map(t=>4==t.buffer.byteLength?t.getUint32(0,!1):void 0);return 2432762113!=i||2449539583!=s?(o("ds4_calibrate_sticks_begin_failed",{d1:i,d2:s}),{ok:!1,error:Error(p(v)),code:1,d1:i,d2:s}):{ok:!0}}catch(t){return o("ds4_calibrate_sticks_begin_failed",{r:t}),{ok:!1,error:t}}}async calibrateSticksSample(){o("ds4_calibrate_sticks_sample");try{await this.sendFeatureReport(144,[3,1,1]),await t(200);const e=await this.receiveFeatureReport(145),n=await this.receiveFeatureReport(146);if(2432762113!=e.getUint32(0,!1)||2449539583!=n.getUint32(0,!1)){const[t,i]=[e,n].map(t=>s(t.getUint32(0,!1)));return o("ds4_calibrate_sticks_sample_failed",{d1:t,d2:i}),{ok:!1,code:2,d1:t,d2:i}}return{ok:!0}}catch(t){return{ok:!1,error:t}}}async calibrateSticksEnd(){o("ds4_calibrate_sticks_end");try{await this.sendFeatureReport(144,[2,1,1]),await t(200);const e=await this.receiveFeatureReport(145),n=await this.receiveFeatureReport(146);if(2432762114!=e.getUint32(0,!1)||2449539329!=n.getUint32(0,!1)){const[t,i]=[e,n].map(t=>s(t.getUint32(0,!1)));return o("ds4_calibrate_sticks_end_failed",{d1:t,d2:i}),{ok:!1,code:3,d1:t,d2:i}}return{ok:!0}}catch(t){return o("ds4_calibrate_sticks_end_failed",{r:t}),{ok:!1,error:t}}}async queryNvStatus(){try{await this.sendFeatureReport(8,[255,0,12]);const t=(await this.receiveFeatureReport(17)).getUint8(1,!1),e={device:"ds4",code:t};switch(t){case 1:return{...e,status:"locked",locked:!0,mode:"temporary"};case 0:return{...e,status:"unlocked",locked:!1,mode:"permanent"};default:return{...e,status:"unknown",locked:null}}}catch(t){return{device:"ds4",status:"error",locked:null,code:2,error:t}}}hwToBoardModel(t){const e=t>>8;return 49==e?"JDM-001":67==e?"JDM-011":84==e?"JDM-030":100>e||e>116?e>128&&132>e||147==e?"JDM-020":164==e||144==e||160==e?"JDM-050":176==e?"JDM-055 (Scuf?)":180==e?"JDM-055":this.isRare(t)?"WOW!":p("Unknown"):"JDM-040"}isRare(t){const e=t>>8,n=e>>4;return 7==n&&e>116||9==n&&147!=e&&144!=e}parseBatteryStatus(t){const e=t.getUint8(29),n=15&e,i=1==(e>>4&1);let s=0,a=!1,r=!1;return i?10>n?(s=Math.min(10*n+5,100),a=!0):10===n?(s=100,a=!0):11===n?s=100:(s=0,r=!0):s=10>n?10*n+5:100,{bat_capacity:s,cable_connected:i,is_charging:a,is_error:r}}async sendOutputReport(t,e=""){if(!this.device?.opened)throw Error("Device is not opened");try{console.log(`Sending output report${e?" to "+e:""}:`,5,n(t)),await this.device.sendReport(5,new Uint8Array(t))}catch(t){throw Error("Failed to send output report: "+t.message)}}updateCurrentOutputState(t){this.currentOutputState={...t}}getCurrentOutputState(){return{...this.currentOutputState}}async initializeCurrentOutputState(){try{this.currentOutputState={...this.getCurrentOutputState(),validFlag0:3,ledRed:0,ledGreen:0,ledBlue:255,ledFlashOn:0,ledFlashOff:0};const t=new M(this.currentOutputState);await this.sendOutputReport(t.pack(),"init default states"),this.updateCurrentOutputState(t)}catch(t){console.warn("Failed to initialize DS4 output state:",t)}}async setVibration(t=0,e=0){try{const{validFlag0:n}=this.currentOutputState,i=new M({...this.currentOutputState,rumbleLeft:Math.max(0,Math.min(255,t)),rumbleRight:Math.max(0,Math.min(255,e)),validFlag0:1|n});return await this.sendOutputReport(i.pack(),"set vibration"),i.validFlag0&=-2,this.updateCurrentOutputState(i),{success:!0,message:"Vibration set successfully"}}catch(t){throw Error("Failed to set vibration",{cause:t})}}async setLightbarColor(t=0,e=0,n=0){try{const{validFlag0:i}=this.currentOutputState,s=new M({...this.currentOutputState,ledRed:Math.max(0,Math.min(255,t)),ledGreen:Math.max(0,Math.min(255,e)),ledBlue:Math.max(0,Math.min(255,n)),validFlag0:2|i});await this.sendOutputReport(s.pack(),"set lightbar color"),s.validFlag0&=-3,this.updateCurrentOutputState(s)}catch(t){throw Error("Failed to set lightbar color",{cause:t})}}async setLightbarBlink(t=0,e=0,n=0,i=0,s=0){try{const{validFlag0:a}=this.currentOutputState,r=new M({...this.currentOutputState,ledRed:Math.max(0,Math.min(255,t)),ledGreen:Math.max(0,Math.min(255,e)),ledBlue:Math.max(0,Math.min(255,n)),ledFlashOn:Math.max(0,Math.min(255,i)),ledFlashOff:Math.max(0,Math.min(255,s)),validFlag0:6|a});await this.sendOutputReport(r.pack(),"set lightbar blink"),r.validFlag0&=-7,this.updateCurrentOutputState(r)}catch(t){throw Error("Failed to set lightbar blink",{cause:t})}}async setSpeakerTone(t="speaker"){if("speaker"===t)throw Error("DS4 does not support playing sound through the built-in speaker. Only 'headphones' output is supported.");const e=new(window.AudioContext||window.webkitAudioContext);"suspended"===e.state&&await e.resume();let n=!1;try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(t=>t.stop()),n=!0}catch(t){throw Error("Microphone permission required to enumerate audio devices",{cause:t})}if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw Error("WebRTC getUserMedia API or mediaDevices enumeration not available.");{const t=(await navigator.mediaDevices.enumerateDevices()).filter(t=>"audiooutput"===t.kind).find(t=>t.label&&/wireless controller|dualshock|sony/i.test(t.label)),n=e.createOscillator();n.type="sine",n.frequency.setValueAtTime(880,e.currentTime);const i=e.createGain();i.gain.setValueAtTime(0,e.currentTime),i.gain.linearRampToValueAtTime(1,e.currentTime+.05),i.gain.linearRampToValueAtTime(1,e.currentTime+.5),i.gain.linearRampToValueAtTime(0,e.currentTime+.25),n.connect(i);let s=null;if(t&&"undefined"!=typeof HTMLMediaElement&&HTMLMediaElement.prototype.setSinkId)try{const a=e.createMediaStreamDestination();i.connect(a),s=new Audio,s.autoplay=!1,s.volume=1,await s.setSinkId(t.deviceId),s.srcObject=a.stream,await s.play(),n.start(),n.stop(e.currentTime+.8)}catch(t){throw Error("Could not set DS4 as audio sink",{cause:t})}setTimeout(()=>{s&&(s.pause(),s.srcObject=null),"closed"!==e.state&&e.close()},1e3)}}getSupportedQuickTests(){return["usb","buttons","haptic","lights","headphone"]}}const E={buttonMap:[{name:"up",byte:7,mask:0},{name:"right",byte:7,mask:1},{name:"down",byte:7,mask:2},{name:"left",byte:7,mask:3},{name:"square",byte:7,mask:16,svg:"Square"},{name:"cross",byte:7,mask:32,svg:"Cross"},{name:"circle",byte:7,mask:64,svg:"Circle"},{name:"triangle",byte:7,mask:128,svg:"Triangle"},{name:"l1",byte:8,mask:1,svg:"L1"},{name:"l2",byte:4,mask:255},{name:"r1",byte:8,mask:2,svg:"R1"},{name:"r2",byte:5,mask:255},{name:"create",byte:8,mask:16,svg:"Create"},{name:"options",byte:8,mask:32,svg:"Options"},{name:"l3",byte:8,mask:64,svg:"L3"},{name:"r3",byte:8,mask:128,svg:"R3"},{name:"ps",byte:9,mask:1,svg:"PS"},{name:"touchpad",byte:9,mask:2,svg:"Trackpad"},{name:"mute",byte:9,mask:4,svg:"Mute"}],dpadByte:7,l2AnalogByte:4,r2AnalogByte:5,touchpadOffset:32},x=128;class F{constructor(t=null){this.buffer=new ArrayBuffer(47),this.view=new DataView(this.buffer),this.validFlag0=t.validFlag0||0,this.validFlag1=t.validFlag1||0,this.validFlag2=t.validFlag2||0,this.bcVibrationRight=t.bcVibrationRight||0,this.bcVibrationLeft=t.bcVibrationLeft||0,this.headphoneVolume=t.headphoneVolume||0,this.speakerVolume=t.speakerVolume||0,this.micVolume=t.micVolume||0,this.audioControl=t.audioControl||0,this.audioControl2=t.audioControl2||0,this.muteLedControl=t.muteLedControl||0,this.powerSaveMuteControl=t.powerSaveMuteControl||0,this.lightbarSetup=t.lightbarSetup||0,this.ledBrightness=t.ledBrightness||0,this.playerIndicator=t.playerIndicator||0,this.ledCRed=t.ledCRed||0,this.ledCGreen=t.ledCGreen||0,this.ledCBlue=t.ledCBlue||0,this.adaptiveTriggerLeftMode=t.adaptiveTriggerLeftMode||0,this.adaptiveTriggerLeftParam0=t.adaptiveTriggerLeftParam0||0,this.adaptiveTriggerLeftParam1=t.adaptiveTriggerLeftParam1||0,this.adaptiveTriggerLeftParam2=t.adaptiveTriggerLeftParam2||0,this.adaptiveTriggerRightMode=t.adaptiveTriggerRightMode||0,this.adaptiveTriggerRightParam0=t.adaptiveTriggerRightParam0||0,this.adaptiveTriggerRightParam1=t.adaptiveTriggerRightParam1||0,this.adaptiveTriggerRightParam2=t.adaptiveTriggerRightParam2||0,this.hapticVolume=t.hapticVolume||0}pack(){this.view.setUint16(0,this.validFlag1<<8|this.validFlag0,!0),this.view.setUint8(2,this.bcVibrationRight),this.view.setUint8(3,this.bcVibrationLeft),this.view.setUint8(4,this.headphoneVolume),this.view.setUint8(5,this.speakerVolume),this.view.setUint8(6,this.micVolume),this.view.setUint8(7,this.audioControl),this.view.setUint8(8,this.muteLedControl),this.view.setUint8(9,0),this.view.setUint8(10,this.adaptiveTriggerRightMode),this.view.setUint8(11,this.adaptiveTriggerRightParam0),this.view.setUint8(12,this.adaptiveTriggerRightParam1),this.view.setUint8(13,this.adaptiveTriggerRightParam2);for(let t=14;20>=t;t++)this.view.setUint8(t,0);this.view.setUint8(21,this.adaptiveTriggerLeftMode),this.view.setUint8(22,this.adaptiveTriggerLeftParam0),this.view.setUint8(23,this.adaptiveTriggerLeftParam1),this.view.setUint8(24,this.adaptiveTriggerLeftParam2);for(let t=25;31>=t;t++)this.view.setUint8(t,0);for(let t=32;42>=t;t++)this.view.setUint8(t,0);return this.view.setUint8(43,this.playerIndicator),this.view.setUint8(44,this.ledCRed),this.view.setUint8(45,this.ledCGreen),this.view.setUint8(46,this.ledCBlue),this.buffer}}class R extends _{constructor(t){super(t),this.model="DS5",this.finetuneMaxValue=65535,this.currentOutputState={validFlag0:0,validFlag1:0,validFlag2:0,bcVibrationRight:0,bcVibrationLeft:0,headphoneVolume:0,speakerVolume:0,micVolume:0,audioControl:0,audioControl2:0,muteLedControl:0,powerSaveMuteControl:0,lightbarSetup:0,ledBrightness:0,playerIndicator:0,ledCRed:0,ledCGreen:0,ledCBlue:0,adaptiveTriggerLeftMode:0,adaptiveTriggerLeftParam0:0,adaptiveTriggerLeftParam1:0,adaptiveTriggerLeftParam2:0,adaptiveTriggerRightMode:0,adaptiveTriggerRightParam0:0,adaptiveTriggerRightParam1:0,adaptiveTriggerRightParam2:0,hapticVolume:0}}getInputConfig(){return E}async getInfo(){return this.M(!1)}async M(t){try{console.log("Fetching DS5 info...");const r=await this.receiveFeatureReport(32);if(console.log("Got DS5 info report:",n(r.buffer)),32!=r.getUint8(0,!0)||64!=r.buffer.byteLength)return{ok:!1,error:Error("Invalid response for ds5_info")};const c=(new TextDecoder).decode(r.buffer.slice(1,12)),l=(new TextDecoder).decode(r.buffer.slice(12,20)),h=r.getUint16(20,!0),u=r.getUint16(22,!0),d=r.getUint32(24,!0),f=r.getUint32(28,!0),w=r.getUint16(44,!0),m=r.getUint8(46,!0),g=r.getUint32(48,!0),b=r.getUint32(52,!0),y=r.getUint32(56,!0),k=await this.getSystemInfo(1,19,17),_={"00":"White","01":"Midnight Black","02":"Cosmic Red","03":"Nova Pink","04":"Galactic Purple","05":"Starlight Blue","06":"Grey Camouflage","07":"Volcanic Red","08":"Sterling Silver","09":"Cobalt Blue",10:"Chroma Teal",11:"Chroma Indigo",12:"Chroma Pearl",30:"30th Anniversary",Z1:"God of War Ragnarok",Z2:"Spider-Man 2",Z3:"Astro Bot",Z4:"Fortnite",Z6:"The Last of Us"}[k.slice(4,6)]||"Unknown",v=[{key:p("Serial Number"),value:k,cat:"hw"},{key:p("MCU Unique ID"),value:await this.getSystemInfo(1,9,9,!1),cat:"hw",isExtra:!0},{key:p("PCBA ID"),value:(e=await this.getSystemInfo(1,17,14),e.split("").reverse().join("")),cat:"hw",isExtra:!0},{key:p("Battery Barcode"),value:await this.getSystemInfo(1,24,23),cat:"hw",isExtra:!0},{key:p("VCM Left Barcode"),value:await this.getSystemInfo(1,26,16),cat:"hw",isExtra:!0},{key:p("VCM Right Barcode"),value:await this.getSystemInfo(1,28,16),cat:"hw",isExtra:!0},{key:p("Color"),value:p(_),cat:"hw",addInfoIcon:"color"},...t?[]:[{key:p("Board Model"),value:this.hwToBoardModel(d),cat:"hw",addInfoIcon:"board"}],{key:p("FW Build Date"),value:c+" "+l,cat:"fw"},{key:p("FW Type"),value:"0x"+i(h),cat:"fw",isExtra:!0},{key:p("FW Series"),value:"0x"+i(u),cat:"fw",isExtra:!0},{key:p("HW Model"),value:"0x"+s(d),cat:"hw",isExtra:!0},{key:p("FW Version"),value:"0x"+s(f),cat:"fw",isExtra:!0},{key:p("FW Update"),value:"0x"+i(w),cat:"fw",isExtra:!0},{key:p("FW Update Info"),value:"0x"+a(m),cat:"fw",isExtra:!0},{key:p("SBL FW Version"),value:"0x"+s(g),cat:"fw",isExtra:!0},{key:p("Venom FW Version"),value:"0x"+s(b),cat:"fw",isExtra:!0},{key:p("Spider FW Version"),value:"0x"+s(y),cat:"fw",isExtra:!0},{key:p("Touchpad ID"),value:await this.getSystemInfo(5,2,8,!1),cat:"hw",isExtra:!0},{key:p("Touchpad FW Version"),value:await this.getSystemInfo(5,4,8,!1),cat:"fw",isExtra:!0}],S=c.search(/ 2020| 2021/);let M=0;-1!=S&&(o("ds5_info_error",{r:"old"}),M|=2);const C=await this.queryNvStatus(),E=await this.getBdAddr();return v.push({key:p("Bluetooth Address"),value:E,cat:"hw",isExtra:!0}),{ok:!0,infoItems:v,nv:C,disable_bits:M,pending_reboot:"pending_reboot"===C?.status}}catch(t){return o("ds5_info_error",{r:t}),{ok:!1,error:t,disable_bits:1}}var e}async flash(t=null){o("ds5_flash");try{await this.nvsUnlock();const t=await this.nvsLock();if(!t.ok)throw t.error||Error("NVS lock failed");return{success:!0,message:p("Changes saved successfully")}}catch(t){throw Error(p("Error while saving changes"),{cause:t})}}async reset(){o("ds5_reset");try{await this.sendFeatureReport(128,[1,1])}catch(t){}}async nvsLock(){try{return await this.sendFeatureReport(128,[3,1]),await this.receiveFeatureReport(129),{ok:!0}}catch(t){return{ok:!1,error:t}}}async nvsUnlock(){try{await this.sendFeatureReport(128,[3,2,101,50,64,12]),await this.receiveFeatureReport(129)}catch(e){throw await t(500),Error(p("NVS Unlock failed"),{cause:e})}}async getBdAddr(){return await this.sendFeatureReport(128,[9,2]),r(await this.receiveFeatureReport(129),4)}async getSystemInfo(t,e,i,s=!0){await this.sendFeatureReport(128,[t,e]);const a=await this.receiveFeatureReport(129);return a.getUint8(1)!=t||a.getUint8(2)!=e||2!=a.getUint8(3)?p("error"):s?(new TextDecoder).decode(a.buffer.slice(4,4+i)):n(a.buffer.slice(4,4+i))}async calibrateSticksBegin(){o("ds5_calibrate_sticks_begin");try{await this.sendFeatureReport(130,[1,1,1]);const t=await this.receiveFeatureReport(131);if(2197881089!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));throw o("ds5_calibrate_sticks_begin_failed",{d1:e}),Error("Stick center calibration begin failed: "+e)}return{ok:!0}}catch(t){return o("ds5_calibrate_sticks_begin_failed",{r:t}),{ok:!1,error:t}}}async calibrateSticksSample(){o("ds5_calibrate_sticks_sample");try{await this.sendFeatureReport(130,[3,1,1]);const t=await this.receiveFeatureReport(131);if(2197881089!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));throw o("ds5_calibrate_sticks_sample_failed",{d1:e}),Error("Stick center calibration sample failed: "+e)}return{ok:!0}}catch(t){return o("ds5_calibrate_sticks_sample_failed",{r:t}),{ok:!1,error:t}}}async calibrateSticksEnd(){o("ds5_calibrate_sticks_end");try{await this.sendFeatureReport(130,[2,1,1]);const t=await this.receiveFeatureReport(131);if(2197881090!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));throw o("ds5_calibrate_sticks_failed",{s:3,d1:e}),Error("Stick center calibration end failed: "+e)}return{ok:!0}}catch(t){return o("ds5_calibrate_sticks_end_failed",{r:t}),{ok:!1,error:t}}}async calibrateRangeBegin(){o("ds5_calibrate_range_begin");try{await this.sendFeatureReport(130,[1,1,2]);const t=await this.receiveFeatureReport(131);if(2197881345!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));throw o("ds5_calibrate_range_begin_failed",{d1:e}),Error("Stick range calibration begin failed: "+e)}return{ok:!0}}catch(t){return o("ds5_calibrate_range_begin_failed",{r:t}),{ok:!1,error:t}}}async calibrateRangeEnd(){o("ds5_calibrate_range_end");try{await this.sendFeatureReport(130,[2,1,2]);const t=await this.receiveFeatureReport(131);if(2197881346!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));throw o("ds5_calibrate_range_end_failed",{d1:e}),Error("Stick range calibration end failed: "+e)}return{ok:!0}}catch(t){return o("ds5_calibrate_range_end_failed",{r:t}),{ok:!1,error:t}}}async queryNvStatus(){try{await this.sendFeatureReport(128,[3,3]);const t=(await this.receiveFeatureReport(129)).getUint32(1,!1);return 352387328===t?{device:"ds5",status:"pending_reboot",locked:null,code:4,raw:t}:50528769===t?{device:"ds5",status:"locked",locked:!0,mode:"temporary",code:1,raw:t}:50528768===t?{device:"ds5",status:"unlocked",locked:!1,mode:"permanent",code:0,raw:t}:1===t||2===t?{device:"ds5",status:"unknown",locked:null,code:2,raw:t}:{device:"ds5",status:"unknown",locked:null,code:t,raw:t}}catch(t){return{device:"ds5",status:"error",locked:null,code:2,error:t}}}hwToBoardModel(t){const e=t>>8&255;return 3==e?"BDM-010":4==e?"BDM-020":5==e?"BDM-030":6==e?"BDM-040":7==e||8==e?"BDM-050":p("Unknown")}async getInMemoryModuleData(){await this.sendFeatureReport(128,[12,2]),await t(100);const e=await this.receiveFeatureReport(129),n=e.getUint8(0,!0),[i,s,a]=[1,2,3].map(t=>e.getUint8(t,!0));return 129!=n||12!=i||2!=s&&4!=s||2!=a?null:Array.from({length:12},(t,n)=>e.getUint16(4+2*n,!0))}async writeFinetuneData(t){const e=t.reduce((t,e)=>t.concat([255&e,e>>8]),[12,1]);await this.sendFeatureReport(128,e)}async sendOutputReport(t,e=""){if(!this.device?.opened)throw Error("Device is not opened");try{console.log(`Sending output report${e?" to "+e:""}:`,2,n(t)),await this.device.sendReport(2,new Uint8Array(t))}catch(t){throw Error("Failed to send output report: "+t.message)}}updateCurrentOutputState(t){this.currentOutputState={...t}}getCurrentOutputState(){return{...this.currentOutputState}}async initializeCurrentOutputState(){try{this.currentOutputState={...this.getCurrentOutputState(),validFlag1:247,ledCRed:0,ledCGreen:0,ledCBlue:255};const t=new F(this.currentOutputState);await this.sendOutputReport(t.pack(),"init default states"),this.updateCurrentOutputState(t)}catch(t){console.warn("Failed to initialize DS5 output state:",t)}}async setAdaptiveTrigger(t,e){try{const n={off:0,single:2,auto:6,resistance:1},{validFlag0:i}=this.currentOutputState,s=new F({...this.currentOutputState,adaptiveTriggerLeftMode:n[t.mode],adaptiveTriggerLeftParam0:t.start,adaptiveTriggerLeftParam1:t.end,adaptiveTriggerLeftParam2:t.force,adaptiveTriggerRightMode:n[e.mode],adaptiveTriggerRightParam0:e.start,adaptiveTriggerRightParam1:e.end,adaptiveTriggerRightParam2:e.force,validFlag0:12|i});return await this.sendOutputReport(s.pack(),"set adaptive trigger mode"),s.validFlag0&=-13,this.updateCurrentOutputState(s),{success:!0}}catch(t){throw Error("Failed to set left adaptive trigger mode",{cause:t})}}async setVibration(t=0,e=0){try{const{validFlag0:n}=this.currentOutputState,i=new F({...this.currentOutputState,bcVibrationLeft:Math.max(0,Math.min(255,t)),bcVibrationRight:Math.max(0,Math.min(255,e)),validFlag0:3|n});await this.sendOutputReport(i.pack(),"set vibration"),i.validFlag0&=-4,this.updateCurrentOutputState(i)}catch(t){throw Error("Failed to set vibration",{cause:t})}}async setSpeakerTone(t="speaker"){try{const{validFlag0:e}=this.currentOutputState,n=new F({...this.currentOutputState,speakerVolume:85,headphoneVolume:55,validFlag0:48|e|x});await this.sendOutputReport(n.pack(),"headphones"===t?"play headphone tone":"play speaker tone"),n.validFlag0&=-177,"headphones"===t?(await this.sendFeatureReport(128,[6,4,0,0,0,0,4,0,6]),await this.sendFeatureReport(128,[6,2,1,1,0])):(await this.sendFeatureReport(128,[6,4,0,0,8]),await this.sendFeatureReport(128,[6,2,1,1,0])),this.updateCurrentOutputState(n)}catch(t){throw Error("Failed to set speaker tone",{cause:t})}}async resetSpeakerSettings(){try{await this.sendFeatureReport(128,[6,2,0,1,0]);const{validFlag0:t}=this.currentOutputState,e=new F({...this.currentOutputState,speakerVolume:0,validFlag0:32|t|x});await this.sendOutputReport(e.pack(),"stop speaker tone"),e.validFlag0&=-161,this.updateCurrentOutputState(e)}catch(t){throw Error("Failed to reset speaker settings",{cause:t})}}async setLightbarColor(t=0,e=0,n=0){try{const{validFlag1:i}=this.currentOutputState,s=new F({...this.currentOutputState,ledCRed:Math.max(0,Math.min(255,t)),ledCGreen:Math.max(0,Math.min(255,e)),ledCBlue:Math.max(0,Math.min(255,n)),validFlag1:4|i});await this.sendOutputReport(s.pack(),"set lightbar color"),s.validFlag1&=-5,this.updateCurrentOutputState(s)}catch(t){throw Error("Failed to set lightbar color",{cause:t})}}async setPlayerIndicator(t=0){try{const{validFlag1:e}=this.currentOutputState,n=new F({...this.currentOutputState,playerIndicator:Math.max(0,Math.min(31,t)),validFlag1:16|e});await this.sendOutputReport(n.pack(),"set player indicator"),n.validFlag1&=-17,this.updateCurrentOutputState(n)}catch(t){throw Error("Failed to set player indicator",{cause:t})}}async resetLights(){try{await this.setLightbarColor(0,0,0),await this.setPlayerIndicator(0),await this.setMuteLed(0)}catch(t){throw Error("Failed to reset lights",{cause:t})}}async setMuteLed(t=0){try{const{validFlag1:e}=this.currentOutputState,n=new F({...this.currentOutputState,muteLedControl:Math.max(0,Math.min(2,t)),validFlag1:1|e});await this.sendOutputReport(n.pack(),"set mute LED"),n.validFlag1&=-2,this.updateCurrentOutputState(n)}catch(t){throw Error("Failed to set mute LED",{cause:t})}}parseBatteryStatus(t){const e=t.getUint8(52),n=15&e;let i=0,s=!1,a=!1,r=!1;switch(e>>4){case 0:i=Math.min(10*n+5,100);break;case 1:i=Math.min(10*n+5,100),a=!0,s=!0;break;case 2:i=100,s=!0;break;case 15:i=0,a=!0,s=!0;break;default:r=!0}return{bat_capacity:i,cable_connected:s,is_charging:a,is_error:r}}}class T extends R{constructor(t){super(t),this.model="DS5_Edge",this.finetuneMaxValue=4095}async getInfo(){const t=await this.M(!0);if(t.ok){const e=Array(17).fill("\0").join("");try{const n=(await this.getBarcode()).map(t=>t===e?p("Unknown"):t);t.infoItems.push({key:p("Left Module Barcode"),value:n[1],cat:"fw"}),t.infoItems.push({key:p("Right Module Barcode"),value:n[0],cat:"fw"})}catch(t){}}return t}async flash(t=null){o("ds5_edge_flash");try{if(await this.flashModules(t))return{success:!0,message:"<b>"+p("Changes saved successfully")+"</b>.<br><br>"+p("If the calibration is not stored permanently, please double-check the wirings of the hardware mod."),isHtml:!0}}catch(t){throw Error(p("Error while saving changes"),{cause:t})}}async getBarcode(){await this.sendFeatureReport(128,[21,34]),await t(100);const e=await this.receiveFeatureReport(129),n=new TextDecoder;return[n.decode(e.buffer.slice(21,38)),n.decode(e.buffer.slice(40,57))]}async unlockModule(e){const n=0==e?"left module":"right module";if(await this.sendFeatureReport(128,[21,6,e,11]),await t(200),!await this.waitUntilWritten([21,6,2]))throw Error(p("Cannot unlock")+" "+p(n))}async lockModule(e){const n=0==e?"left module":"right module";if(await this.sendFeatureReport(128,[21,4,e,8]),await t(200),!await this.waitUntilWritten([21,4,2]))throw Error(p("Cannot lock")+" "+p(n))}async storeDataInto(e){const n=0==e?"left module":"right module";if(await this.sendFeatureReport(128,[21,5,e]),await t(200),!await this.waitUntilWritten([21,3,2]))throw Error(p("Cannot store data into")+" "+p(n))}async flashModules(e){o("ds5_edge_flash_modules");try{e(0),await t(100),e(10),await this.unlockModule(0),e(15),await this.unlockModule(1),e(30),await this.nvsUnlock(),await t(50),e(45);const n=await this.getInMemoryModuleData();await t(50),e(60),await this.writeFinetuneData(n),await t(100),await this.lockModule(0),e(80),await this.lockModule(1),e(100),await t(100);const i=await this.nvsLock();if(!i.ok)throw i.error||Error("NVS lock failed");return await t(250),!0}catch(t){throw o("ds5_edge_flash_modules_failed",{r:t}),t}}async waitUntilWritten(e){let n=0;for(;10>n;){const i=await this.receiveFeatureReport(129);if(e.every((t,e)=>i.getUint8(1+e,!0)===t))return!0;n++,await t(50)}return!1}async calibrateSticksEnd(){o("ds5_calibrate_sticks_end");try{await this.sendFeatureReport(130,[2,1,1]);let t=await this.receiveFeatureReport(131);if(2197881089!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));return o("ds5_calibrate_sticks_failed",{s:3,d1:e}),{ok:!1,code:4,d1:e}}if(await this.sendFeatureReport(130,[2,1,1]),t=await this.receiveFeatureReport(131),2197881091!=t.getUint32(0,!1)&&2197881618!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));return o("ds5_calibrate_sticks_failed",{s:3,d1:e}),{ok:!1,code:5,d1:e}}return{ok:!0}}catch(t){return o("ds5_calibrate_sticks_end_failed",{r:t}),{ok:!1,error:t}}}async calibrateRangeEnd(){o("ds5_calibrate_range_end");try{await this.sendFeatureReport(130,[2,1,2]);let t=await this.receiveFeatureReport(131);if(2197881345!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));return o("ds5_calibrate_range_end_failed",{d1:e}),{ok:!1,code:4,d1:e}}if(await this.sendFeatureReport(130,[2,1,2]),t=await this.receiveFeatureReport(131),2197881347!=t.getUint32(0,!1)){const e=s(t.getUint32(0,!1));return o("ds5_calibrate_range_end_failed",{d1:e}),{ok:!1,code:5,d1:e}}return{ok:!0}}catch(t){return o("ds5_calibrate_range_end_failed",{r:t}),{ok:!1,error:t}}}async getInMemoryModuleData(){await this.sendFeatureReport(128,[12,4]),await t(100);const e=await this.receiveFeatureReport(129),n=e.getUint8(0,!0),[i,s,a]=[1,2,3].map(t=>e.getUint8(t,!0));return 129!=n||12!=i||2!=s&&4!=s||2!=a?null:Array.from({length:12},(t,n)=>e.getUint16(4+2*n,!0))}async writeFinetuneData(t){const e=t.reduce((t,e)=>t.concat([255&e,e>>8]),[12,1]);await this.sendFeatureReport(128,e)}}class I{static getSupportedModels(){return[{vendorId:1356,productId:1476},{vendorId:1356,productId:2508},{vendorId:1356,productId:3302},{vendorId:1356,productId:3570}]}static createControllerInstance(t){switch(t.productId){case 1476:case 2508:return new C(t);case 3302:return new R(t);case 3570:return new T(t);default:throw Error(`Unsupported device: ${i(t.vendorId)}:${i(t.productId)}`)}}static getDeviceName(t){switch(t){case 1476:return"Sony DualShock 4 V1";case 2508:return"Sony DualShock 4 V2";case 3302:return"Sony DualSense";case 3570:return"Sony DualSense Edge";default:return"Unknown Device"}}static getUIConfig(t){switch(t){case 1476:case 2508:return{showInfo:!1,showFinetune:!1,showInfoTab:!1,showFourStepCalib:!0,showQuickCalib:!1};case 3302:case 3570:return{showInfo:!0,showFinetune:!0,showInfoTab:!0,showFourStepCalib:!1,showQuickCalib:!0};default:return{showInfo:!1,showFinetune:!1,showInfoTab:!1,showFourStepCalib:!1,showQuickCalib:!1}}}}const B=new Map;const D=48;function L(t){const e=Math.sqrt(Math.pow(1-t,2));let n;return n=t>1?(245+115*Math.min(1,Math.max(0,e-.05)/.15))%360:220-220*Math.min(1,Math.max(0,e-.05)/.1),parseInt(n)}function A(t,e,n,i,s,a,r={}){const{circularity_data:o=null,enable_zoom_center:c=!1,highlight:l}=r;if(t.lineWidth=1,t.fillStyle="#ffffff",t.strokeStyle="#000000",t.beginPath(),t.arc(e,n,i,0,2*Math.PI),t.closePath(),t.fill(),t.stroke(),o?.length>0){const s=D;for(let a=0;s>a;a++){const r=o[a],c=o[(a+1)%D];if(void 0===r||void 0===c)continue;const l=a*Math.PI*2/s,h=(a+1)%s*2*Math.PI/s,u=Math.cos(l)*r,d=Math.sin(l)*r,f=Math.cos(h)*c,w=Math.sin(h)*c;t.beginPath(),t.moveTo(e,n),t.lineTo(e+u*i,n+d*i),t.lineTo(e+f*i,n+w*i),t.lineTo(e,n),t.closePath();const m=L((r+c)/2);t.fillStyle=`hsla(${m}, 100%, 50%, 0.5)`,t.fill()}}if(o&&o.filter(t=>t>.3).length>10){const s=function(t){const e=t.reduce((t,e)=>e>.2?t+Math.pow(e-1,2):t,0),n=t.filter(t=>t>.2).length;return n>0?100*Math.sqrt(e/n):0}(o);t.fillStyle="#fff",t.strokeStyle="#444",t.lineWidth=3,t.textAlign="center",t.textBaseline="middle",t.font="24px Arial";const a=n+.5*i,r=s.toFixed(1)+" %";t.strokeText(r,e,a),t.fillText(r,e,a)}t.strokeStyle="#aaaaaa",t.lineWidth=1,t.beginPath(),t.moveTo(e-i,n),t.lineTo(e+i,n),t.closePath(),t.stroke(),t.beginPath(),t.moveTo(e,n-i),t.lineTo(e,n+i),t.closePath(),t.stroke();let h=s,u=a;if(c){const r=function(t,e){const n=Math.sqrt(t*t+e*e);if(0===n)return{x:t,y:e};const i=Math.atan2(e,t),s=n>.05?.5+(n-.05)/.95*.5:n/.05*.5;return{x:Math.cos(i)*s,y:Math.sin(i)*s}}(s,a);h=r.x,u=r.y,t.strokeStyle="#d3d3d3",t.lineWidth=1,t.beginPath(),t.arc(e,n,.5*i,0,2*Math.PI),t.stroke()}t.fillStyle="#000000",t.strokeStyle="#000000";const d=Math.sqrt(h*h+u*u);if(c&&d>.5){const s=h/d*.5,a=u/d*.5;t.lineWidth=3,t.beginPath(),t.moveTo(e,n),t.lineTo(e+s*i,n+a*i),t.stroke(),t.lineWidth=1,t.beginPath(),t.moveTo(e+s*i,n+a*i),t.lineTo(e+h*i,n+u*i),t.stroke()}else t.lineWidth=c?3:1,t.beginPath(),t.moveTo(e,n),t.lineTo(e+h*i,n+u*i),t.stroke();t.beginPath(),t.arc(e+h*i,n+u*i,l?4:3,0,2*Math.PI),t.fillStyle=l?"#2989f7ff":"#030b84ff",t.fill()}class ${constructor(t,e=null){this.controller=t,this.doneCallback=e,this.C=this.F.bind(this),this.R();const n=document.getElementById("calibNext");n&&(n.disabled=!1);const i=document.getElementById("btnSpinner");i&&(i.style.display="none")}F(){console.log("Closing calibration modal"),U()}R(){const t=document.getElementById("calibCenterModal");t&&t.addEventListener("hidden.bs.modal",this.C)}setProgress(t){const e=document.getElementById("calib-center-progress");e&&(e.style.width=t+"%")}removeEventListeners(){const t=document.getElementById("calibCenterModal");t&&t.removeEventListener("hidden.bs.modal",this.C)}async open(){o("calib_open"),this.calibrationGenerator=this.calibrationSteps(),await this.next();const t=document.getElementById("calibCenterModal");bootstrap.Modal.getOrCreateInstance(t).show()}async next(){o("calib_next"),this.calibrationGenerator&&(await this.calibrationGenerator.next()).done&&(this.calibrationGenerator=null)}async*calibrationSteps(){o("calib_step",{i:1}),this.T(1,"Stick center calibration","Start",!0),yield 1,o("calib_step",{i:2}),this.I("Initializing..."),await t(100),await this.B(),await this.D(),this.T(2,"Calibration in progress","Continue",!1),yield 2;for(let e=3;5>=e;e++)o("calib_step",{i:e}),this.I("Sampling..."),await t(150),await this.L(),await this.D(),this.T(e,"Calibration in progress","Continue",!1),yield e;o("calib_step",{i:6}),this.I("Sampling..."),await this.L(),await t(200);const e=document.getElementById("calibNextText");e&&(e.textContent=p("Storing calibration...")),await t(500),await this.A(),await this.D(),this.T(6,"Stick center calibration","Done",!0),yield 6,this.$(!0)}async multiCalibrateSticks(){if(!this.controller.isConnected())return;this.setProgress(0);const e=document.getElementById("autoCalibCenterModal"),n=bootstrap.Modal.getOrCreateInstance(e);n.show(),await t(1e3),this.setProgress(10);const i=await this.controller.calibrateSticks(t=>{this.setProgress(t)});await t(500),n.hide(),this.$(!0,i?.message)}async B(){await this.controller.calibrateSticksBegin()}async A(){await this.controller.calibrateSticksEnd()}async L(){await this.controller.calibrateSticksSample()}$(t=!1,e=null){this.doneCallback&&"function"==typeof this.doneCallback&&this.doneCallback(t,e);const n=document.getElementById("calibCenterModal");bootstrap.Modal.getOrCreateInstance(n).hide()}T(t,e,n,i){for(let t=1;7>t;t++){const e=document.getElementById("list-"+t);e&&(e.style.display="none");const n=document.getElementById("list-"+t+"-calib");n&&n.classList.remove("active")}const s=document.getElementById("list-"+t);s&&(s.style.display="block");const a=document.getElementById("list-"+t+"-calib");a&&a.classList.add("active");const r=document.getElementById("calibTitle");r&&(r.textContent=p(e));const o=document.getElementById("calibNextText");o&&(o.textContent=p(n));const c=document.getElementById("calibCross");c&&(c.style.display=i?"block":"none");const l=document.getElementById("quickCalibBtn");l&&(l.style.display=1===t?"inline-block":"none")}I(t){const e=document.getElementById("calibNextText");e&&(e.textContent=p(t));const n=document.getElementById("btnSpinner");n&&(n.style.display="inline-block");const i=document.getElementById("calibNext");i&&(i.disabled=!0)}async D(){await t(200);const e=document.getElementById("calibNext");e&&(e.disabled=!1);const n=document.getElementById("btnSpinner");n&&(n.style.display="none")}}let P=null;function U(){P&&(console.log("Destroying current calibration instance"),P.removeEventListeners(),P=null)}async function auto_calibrate_stick_centers(t,e=null){P=new $(t,e),await P.multiCalibrateSticks()}window.calib_next=async function(){P&&await P.next()},window.quick_calibrate_instead=async function(){if(P){const t=P.doneCallback;P.doneCallback=null,P.$();const{controller:e}=P;U(),await auto_calibrate_stick_centers(e,t)}};class V{constructor(t,{ll_data:e,rr_data:n},i=null){this.controller=t,this.ll_data=e,this.rr_data=n,this.buttonText=p("Done"),this.leftNonZeroCount=0,this.rightNonZeroCount=0,this.leftFullCycles=0,this.rightFullCycles=0,this.requiredFullCycles=4,this.progressUpdateInterval=null,this.countdownSeconds=0,this.countdownInterval=null,this.leftCycleProgress=0,this.rightCycleProgress=0,this.allDonePromiseResolve=void 0,this.doneCallback=i}async open(){if(!this.controller.isConnected())return;const e=document.getElementById("range-calibration-alert");e&&(e.style.display="none");const n=document.getElementById("keep-rotating-alert");n&&n.classList.remove("blink-text");const i=document.getElementById("range-done-btn");i&&(i.disabled=!0,i.classList.remove("btn-primary"),i.classList.add("btn-outline-primary"));const s=document.getElementById("rangeModal");bootstrap.Modal.getOrCreateInstance(s).show(),this.ll_data.fill(0),this.rr_data.fill(0),this.updateProgress(),this.startProgressMonitoring(),this.resetAlertEnhancement(),this.startCountdown(),await t(1e3),await this.controller.calibrateRangeBegin()}async onClose(){this.stopProgressMonitoring(),this.stopCountdown();const t=document.getElementById("rangeModal");bootstrap.Modal.getOrCreateInstance(t).hide();const e=await this.controller.calibrateRangeOnClose();this.doneCallback&&"function"==typeof this.doneCallback&&this.doneCallback(!0,e?.message),this.allDonePromiseResolve&&this.allDonePromiseResolve()}startProgressMonitoring(){this.progressUpdateInterval=setInterval(()=>{this.checkDataProgress()},100)}stopProgressMonitoring(){this.progressUpdateInterval&&(clearInterval(this.progressUpdateInterval),this.progressUpdateInterval=null)}startCountdown(){this.countdownSeconds=15,this.updateCountdownButton(),this.countdownInterval=setInterval(()=>{if(this.countdownSeconds--,this.countdownSeconds>0&&100>this.leftCycleProgress+this.rightCycleProgress)this.checkAndEnhanceAlert();else{this.stopCountdown();const t=document.getElementById("range-calibration-alert");t&&(t.style.display="none");const e=document.getElementById("range-done-btn");e&&(e.disabled=!1,e.classList.add("btn-primary"),e.classList.remove("btn-outline-primary")),this.updateCountdownButton()}this.updateCountdownButton()},1e3)}stopCountdown(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null,this.countdownSeconds=0,this.updateCountdownButton())}updateCountdownButton(){const t=this.countdownSeconds,e=this.buttonText+(t>0?` (${t})`:""),n=document.getElementById("range-done-btn");n&&(n.textContent=e)}checkDataProgress(){const t=this.ll_data.filter(t=>t>.95).length;.95>t/D||(this.leftFullCycles++,this.ll_data.fill(0));const e=this.rr_data.filter(t=>t>.95).length;.95>e/D||(this.rightFullCycles++,this.rr_data.fill(0)),t===this.leftNonZeroCount&&e===this.rightNonZeroCount||(this.leftNonZeroCount=t,this.rightNonZeroCount=e,this.updateProgress())}updateProgress(){const t=50*Math.min(1,this.leftFullCycles/this.requiredFullCycles),e=50*Math.min(1,this.rightFullCycles/this.requiredFullCycles);this.leftCycleProgress=t,this.rightCycleProgress=e;const n=this.leftNonZeroCount/D*(50/this.requiredFullCycles),i=this.rightNonZeroCount/D*(50/this.requiredFullCycles),s=Math.round(Math.min(50,t+n)+Math.min(50,e+i)),a=document.getElementById("range-progress-bar");a&&(a.style.width=s+"%",a.setAttribute("aria-valuenow",s))}checkAndEnhanceAlert(){const t=15-this.countdownSeconds,e=document.getElementById("range-calibration-alert"),n=e&&null!==e.offsetParent,i=10>this.leftCycleProgress||10>this.rightCycleProgress;5>t||!i||n||e&&(e.style.display="block");const s=document.getElementById("keep-rotating-alert");if(s){const e=s.classList.contains("blink-text");7>t||!i||e||s.classList.add("blink-text")}}resetAlertEnhancement(){const t=document.getElementById("keep-rotating-alert");t&&t.classList.remove("blink-text")}}let N=null;function j(){N=null}async function calibrate_range(t,e,n=null){return j(),N=new V(t,e,n),await N.open(),new Promise(t=>{N.allDonePromiseResolve=t})}window.calibrate_range_on_close=async function(){N&&(await N.onClose(),j())};const O=["LL","LT","RL","RT","LR","LB","RR","RB","LX","LY","RX","RY"],W=["left","right"],q={left:{suffixes:["LL","LT","LR","LB"],axisX:"LX",axisY:"LY",circDataName:"ll_data",canvasName:"finetuneStickCanvasL"},right:{suffixes:["RL","RT","RR","RB"],axisX:"RX",axisY:"RY",circDataName:"rr_data",canvasName:"finetuneStickCanvasR"}},z=[{selector:"#finetuneModeCenter",event:"change",handler:(t,e)=>e.target.checked&&t.setMode("center")},{selector:"#finetuneModeCircularity",event:"change",handler:(t,e)=>e.target.checked&&t.setMode("circularity")},{selector:"#showRawNumbersCheckbox",event:"change",handler:t=>t.P()},{selector:"#learn-more-link",event:"click",handler:(t,e)=>{e.preventDefault(),document.getElementById("learn-more-link").style.display="none",document.getElementById("learn-more-text").style.display="block"}},{selector:".dropdown-item[data-step]",event:"click",handler:(t,e)=>{e.preventDefault(),t.stepSize=parseInt(e.target.dataset.step)}},{selector:"#finetuneModal",event:"hidden.bs.modal",handler:t=>t.U()}];class G{constructor(){this.V="center",this.original_data=[],this.active_stick=null,this.N=5,this.O=5,this.isQuickCalibrating=!1,this.controller=null,this.ll_data=null,this.rr_data=null,this.clearCircularity=null,this.doneCallback=null,this.refresh_finetune_sticks=this.W(),this.update_finetune_warning_messages=this.q(),this.flash_finetune_warning=this.G(),this.continuous_adjustment={initial_delay:null,repeat_delay:null},this.H={left:0,right:0},this.Y={left:null,right:null},this.J={left:!1,right:!1},this.X={left:{x:0,y:0},right:{x:0,y:0}},this.Z=[]}get mode(){return this.V}set mode(t){if("center"!==t&&"circularity"!==t)throw Error(`Invalid finetune mode: ${t}. Must be 'center' or 'circularity'`);this.V=t,this.T()}get stepSize(){return"center"===this.V?this.N:this.O}set stepSize(t){"center"===this.V?this.N=t:this.O=t,this.K(),this.tt()}async init(t,{ll_data:e,rr_data:n,clear_circularity:i},a=null){o("finetune_modal_open"),this.controller=t,this.ll_data=e,this.rr_data=n,this.clearCircularity=i,this.doneCallback=a,this.R(),this.et(),this.nt();const r=await this.controller.queryNvStatus();if(r.locked){if("locked"!==r.status)throw Error("ERROR: Cannot read NVS status. Finetuning is not safe on this device.")}else{if(!(await this.controller.nvsLock()).ok)return;const t=await this.controller.queryNvStatus();if(!t.locked){const e="0x"+s(t.raw);throw Error("ERROR: Cannot lock NVS ("+e+")")}}const c=await this.it(),l=document.getElementById("finetuneModal");bootstrap.Modal.getOrCreateInstance(l).show(),this.st(c),this.setMode("center"),this.setStickToFinetune("left"),this.P(),this.original_data=c,this.rt(),document.getElementById("learn-more-link").style.display="inline",document.getElementById("learn-more-text").style.display="none",this.refresh_finetune_sticks()}ot(t,e,n){t&&(t.addEventListener(e,n),this.Z.push({element:t,event:e,handler:n}))}R(){O.forEach(t=>{const e=document.getElementById("finetune"+t);e&&this.ot(e,"change",()=>this.ct())}),z.forEach(t=>{document.querySelectorAll(t.selector).forEach(e=>{this.ot(e,t.event,e=>t.handler(this,e))})}),this.lt()}lt(){W.forEach(t=>{const e=document.getElementById(t+"-stick-card");e&&this.ot(e,"click",()=>{this.setStickToFinetune(t)}),this.ht(t),this.ut(t)})}ht(t){const e=t+"CircularitySlider",n=document.getElementById(e);if(n){this.ot(n,"input",e=>{this.dt(t,parseInt(e.target.value))});const e=e=>{this.ft(t,parseInt(e.target.value))};this.ot(n,"mousedown",e),this.ot(n,"touchstart",e),this.ot(n,"change",e=>{this.wt(t)})}}ut(t){const e=document.getElementById(t+"CircularityResetBtn");e&&this.ot(e,"click",()=>this.gt(t));const n=document.getElementById(t+"ErrorSlackBtn");n&&this.ot(n,"click",()=>this.bt(t));const i=document.getElementById(t+"ErrorSlackUndoBtn");i&&this.ot(i,"click",()=>this.yt(t))}removeEventListeners(){this.Z.forEach(({element:t,event:e,handler:n})=>{t.removeEventListener(e,n)}),this.Z=[]}U(){console.log("Finetune modal hidden event triggered"),this.isQuickCalibrating?console.log("Quick calibration in progress, preventing dialog destruction"):(W.forEach(t=>{const e=document.getElementById(t+"CircularitySlider");e&&(e.value=0),this.J[t]=!1}),H&&(H.stopContinuousDpadAdjustment(),H.removeEventListeners(),H=null))}handleModeSwitching(t){t.l1?(this.setMode("center"),this.kt()):t.r1&&(this.setMode("circularity"),this.kt())}handleStickSwitching(t){t.sticks&&this._t()}handleDpadAdjustment(t){this.active_stick&&("center"===this.V?this.vt(t):this.St(t))}setQuickCalibrating(t){this.isQuickCalibrating=t;const e=document.getElementById("finetuneModal"),n=bootstrap.Modal.getInstance(e);t?n.hide():(n.show(),this.clearCircularity(),this.it().then(t=>{this.st(t),this.refresh_finetune_sticks(),console.log("Finetune modal refreshed")}))}save(){this.controller.setHasChangesToWrite(!0),this.$(!0)}async cancel(){12==this.original_data.length&&await this.Mt(this.original_data),this.$(!1)}setMode(t){this.V=t,this.T(),"center"===t&&W.forEach(t=>{const e=document.getElementById(t+"-stick-card");e&&e.classList.remove("show-slider"),this.J[t]=!1,this.Ct(t)})}setStickToFinetune(t){if(this.active_stick===t)return;if(this.stopContinuousDpadAdjustment(),this.kt(),this.active_stick&&"circularity"===this.V){const t=document.getElementById(this.active_stick+"-stick-card");t&&t.classList.remove("show-slider")}this.active_stick=t;const e="left"===t?"right":"left";document.getElementById(this.active_stick+"-stick-card")?.classList.add("stick-card-active"),document.getElementById(e+"-stick-card")?.classList.remove("stick-card-active")}et(){const t=localStorage.getItem("showRawNumbersCheckbox");if(t){const e="true"===t,n=document.getElementById("showRawNumbersCheckbox");n&&(n.checked=e)}}st(t){const e=this.controller.getFinetuneMaxValue();O.forEach((n,i)=>{const s=document.getElementById("finetune"+n);s&&(s.setAttribute("max",e),s.value=t[i])})}Et(t){const e=Math.max(Math.abs(t.x),Math.abs(t.y)),n=Math.min(Math.abs(t.x),Math.abs(t.y));return e>=.5&&.2>n}T(){this.clearCircularity();const t=document.getElementById("finetuneModal");if("center"===this.V){const e=document.getElementById("finetuneModeCenter");e&&(e.checked=!0),t.classList.remove("circularity-mode")}else if("circularity"===this.V){const e=document.getElementById("finetuneModeCircularity");e&&(e.checked=!0),t.classList.add("circularity-mode")}this.K(),this.rt()}async ct(){const t=O.map(t=>{const e=document.getElementById("finetune"+t),n=parseInt(e?.value);return isNaN(n)?0:n});await this.Mt(t)}async it(){const t=await this.controller.getInMemoryModuleData();if(!t)throw Error("ERROR: Cannot read calibration data");return t}async Mt(t){12==t.length&&this.controller.isConnected()&&await this.controller.writeFinetuneData(t)}W(){let t=null;return()=>{t||(t=setTimeout(()=>{const e=this.controller.button_states.sticks;Object.entries(q).forEach(([t,n])=>{const i=e[t];this.xt(n.canvasName,i.x,i.y)}),this.update_finetune_warning_messages(),this.Ft(),this.rt(),t=null},10))}}q(){let t=null;return()=>{if(!this.active_stick)return;const e=this.controller.button_states.sticks[this.active_stick],n=document.getElementById("finetuneCenterSuccess"),i=document.getElementById("finetuneCenterWarning"),s=document.getElementById("finetuneCircularitySuccess"),a=document.getElementById("finetuneCircularityWarning");if("center"===this.V){const s=.5>=Math.abs(e.x)&&.5>=Math.abs(e.y);if(!s&&t)return;clearTimeout(t),t=setTimeout(()=>{t=null,"center"===this.V&&(n&&(n.style.display=s?"block":"none"),i&&(i.style.display=s?"none":"block"))},s?0:200)}if("circularity"===this.V){const n=this.Et(e);if(!n&&t)return;clearTimeout(t),t=setTimeout(()=>{t=null,"circularity"===this.V&&(s&&(s.style.display=n?"block":"none"),a&&(a.style.display=n?"none":"block"))},n?0:200)}}}kt(t={center:!0,circularity:!0}){const{center:e,circularity:n}=t;("center"===this.V&&e||"circularity"===this.V&&n)&&["Lx-lbl","Ly-lbl","Rx-lbl","Ry-lbl"].forEach(t=>{const e=document.getElementById("finetuneStickCanvas"+t);e&&e.classList.remove("text-primary")})}Ft(t={}){if(this.active_stick)if("center"===this.V){const{axis:e}=t;if(!e)return;this.kt({center:!0});const n=`${"left"===this.active_stick?"L":"R"}${e.toLowerCase()}`,i=document.getElementById(`finetuneStickCanvas${n}-lbl`);i&&i.classList.add("text-primary")}else{this.kt({circularity:!0});const t=this.controller.button_states.sticks[this.active_stick],e=.5;if(Math.abs(t.x)>=e||Math.abs(t.y)>=e){const e=this.Rt(t.x,t.y);if(this.Tt(this.active_stick,e)){const t=`finetuneStickCanvas${"left"===this.active_stick?"L":"R"}${"left"===e||"right"===e?"x":"y"}-lbl`,n=document.getElementById(t);n&&n.classList.add("text-primary")}}}}xt(t,n,i){const s=document.getElementById("showRawNumbersCheckbox"),a=`${t}${s&&s.checked?"":"_large"}`,r=document.getElementById(a);if(!r)return void console.error("Canvas element not found: "+a);const o=r.getContext("2d"),c=r.width/2-5,l=r.width/2-5,h=c+5,u=c+5;o.clearRect(0,0,r.width,r.height);const d=this.It(t),f=this.active_stick===d&&this.Bt();"circularity"===this.V?A(o,h,u,l,n,i,{circularity_data:"left"===d?this.ll_data:this.rr_data,highlight:f}):A(o,h,u,l,n,i,{enable_zoom_center:!0,highlight:f});const w=document.getElementById(t+"x-lbl");w&&(w.textContent=e(n,3));const m=document.getElementById(t+"y-lbl");m&&(m.textContent=e(i,3))}It(t){return W.find(e=>q[e].canvasName===t)}P(){const t=document.getElementById("showRawNumbersCheckbox"),e=t&&t.checked,n=document.getElementById("finetuneModal");n&&(e?n.classList.remove("hide-raw-numbers"):n.classList.add("hide-raw-numbers")),localStorage.setItem("showRawNumbersCheckbox",e),this.refresh_finetune_sticks()}$(t=!1,e=null){console.log("Closing finetune modal"),this.doneCallback&&"function"==typeof this.doneCallback&&this.doneCallback(t,e);const n=document.getElementById("finetuneModal");bootstrap.Modal.getOrCreateInstance(n).hide()}Dt(t,e=.2){return Math.abs(t.x)>=e||Math.abs(t.y)>=e}_t(){const t=this.controller.button_states.sticks,e=this.Dt(t.left,.2),n=this.Dt(t.right,.2);e&&n?this.Lt():e&&!n?this.setStickToFinetune("left"):n&&!e&&this.setStickToFinetune("right")}Lt(){document.getElementById("left-stick-card")?.classList.remove("stick-card-active"),document.getElementById("right-stick-card")?.classList.remove("stick-card-active"),this.active_stick=null,this.kt()}Rt(t,e){return Math.abs(t)>Math.abs(e)?t>0?"right":"left":e>0?"down":"up"}Tt(t,e){if("center"===this.V)return console.warn("get_finetune_input_suffix_for_quadrant called in center mode - this should not happen"),null;const n=q[t];if(!n)return null;const i={left:0,up:1,right:2,down:3}[e];return void 0!==i?n.suffixes[i]:null}vt(t){const e=this.N,n=[{buttons:["left","square"],adjustment:e,axis:"X"},{buttons:["right","circle"],adjustment:-e,axis:"X"},{buttons:["up","triangle"],adjustment:e,axis:"Y"},{buttons:["down","cross"],adjustment:-e,axis:"Y"}];if(["left","right","square","circle","up","down","triangle","cross"].some(e=>!1===t[e]))this.stopContinuousDpadAdjustment();else for(const e of n){const n=this.controller.button_states.sticks[this.active_stick];if((Math.abs(n.x)>.5||Math.abs(n.y)>.5)&&this.At())return void this.flash_finetune_warning();if(e.buttons.some(e=>t[e]))return this.Ft({axis:e.axis}),void this.$t(this.active_stick,e.axis,e.adjustment)}}At(){return["left","right","up","down","square","circle","triangle","cross"].some(t=>!0===this.controller.button_states[t])}G(){let t=null;return()=>{function e(){const t=document.getElementById("finetuneCenterWarning"),e=document.getElementById("finetuneCircularityWarning");t&&(t.classList.toggle("alert-warning"),t.classList.toggle("alert-danger")),e&&(e.classList.toggle("alert-warning"),e.classList.toggle("alert-danger"))}t||(e(),t=setTimeout(()=>{e(),t=null},300))}}St({sticks:t,...e}){const n=this.controller.button_states.sticks[this.active_stick];if(!this.Et(n))return this.stopContinuousDpadAdjustment(),void(this.At()&&this.flash_finetune_warning());const i=this.Rt(n.x,n.y),s=this.O;let a=0,r=[];"left"===i||"right"===i?(r=["left","right","square","circle"],e.left||e.square?a=s:(e.right||e.circle)&&(a=-s)):"up"!==i&&"down"!==i||(r=["up","down","triangle","cross"],e.up||e.triangle?a=s:(e.down||e.cross)&&(a=-s)),r.some(t=>!1===e[t])?this.stopContinuousDpadAdjustment():0!==a&&this.Pt(this.active_stick,i,a)}Pt(t,e,n){const i=this.Tt(t,e);this.Ut(i,n)}$t(t,e,n){const i=q[t],s="X"===e?i.axisX:i.axisY;this.Ut(s,n)}Ut(t,e){this.stopContinuousDpadAdjustment();const n=document.getElementById("finetune"+t);if(n){if(this.active_stick&&this.controller.button_states.sticks){const t=this.controller.button_states.sticks[this.active_stick];this.X[this.active_stick].x=t.x,this.X[this.active_stick].y=t.y}this.Vt(n,e),this.clearCircularity(),this.continuous_adjustment.initial_delay=setTimeout(()=>{this.continuous_adjustment.repeat_delay=setInterval(()=>{this.Vt(n,e),this.clearCircularity()},150)},400)}}stopContinuousDpadAdjustment(){this.continuous_adjustment.repeat_delay&&(clearInterval(this.continuous_adjustment.repeat_delay),this.continuous_adjustment.repeat_delay=null),this.continuous_adjustment.initial_delay&&(clearTimeout(this.continuous_adjustment.initial_delay),this.continuous_adjustment.initial_delay=null)}Bt(){return!!this.continuous_adjustment.initial_delay}async Vt(t,e){const n=parseInt(t.value)||0,i=this.controller.getFinetuneMaxValue(),s=Math.max(0,Math.min(i,n+e));t.value=s,await this.ct(),this.Nt()}Nt(){if(!this.active_stick||!this.continuous_adjustment.repeat_delay)return;const t=this.controller.button_states.sticks[this.active_stick],e=this.X[this.active_stick],n=Math.abs(e.x)>=1&&1>Math.abs(t.x),i=Math.abs(e.y)>=1&&1>Math.abs(t.y);(n||i)&&(console.log(`Stopping continuous adjustment: ${this.active_stick} axis dropped below 1.00`),this.stopContinuousDpadAdjustment()),this.X[this.active_stick]=t}K(){const t="center"===this.V?this.N:this.O;document.getElementById("stepSizeValue").textContent=t}tt(){localStorage.setItem("finetuneCenterStepSize",this.N.toString()),localStorage.setItem("finetuneCircularityStepSize",this.O.toString())}nt(){const t=localStorage.getItem("finetuneCenterStepSize");t&&(this.N=parseInt(t));const e=localStorage.getItem("finetuneCircularityStepSize");e&&(this.O=parseInt(e)),this.K()}jt(){const t=document.getElementById("leftCircularitySlider");t&&(t.value=0);const e=document.getElementById("rightCircularitySlider");e&&(e.value=0)}ft(t,e){console.log(`Slider start for ${t} stick, value: ${e}`);const n=q[t],i={};n.suffixes.forEach(t=>{const e=document.getElementById("finetune"+t);i[t]=parseInt(e?.value)||0}),this.Y[t]=i,this.H[t]=e;const s=this[n.circDataName];s&&Array.isArray(s)&&(this.Y[t][n.circDataName]=[...s]),console.log(`Base values stored for ${t}:`,i)}dt(t,e){if(console.log(`Slider change for ${t} stick, value: ${e}`),!this.Y[t])return void this.ft(t,e);if(0===e-this.H[t])return;const n=q[t],i=this.Y[t],s=e/100*175;n.suffixes.forEach(t=>{const e=document.getElementById("finetune"+t);let n;t.endsWith("L")||t.endsWith("T")?n=Math.min(65535,i[t]+s):(t.endsWith("R")||t.endsWith("B"))&&(n=Math.max(0,i[t]-s)),e&&(e.value=Math.round(n))});const a=85e-5*s,r=this.Y[t][n.circDataName],o=this[n.circDataName];r.forEach((t,e)=>o[e]=Math.max(0,t+a)),this.Ot(o),this.H[t]=e,this.refresh_finetune_sticks()}wt(t){console.log(`Circularity slider released for ${t} stick`),this.J[t]=!0,this[q[t].circDataName].fill(0),this.clearCircularity(),this.ct();const e=document.getElementById(t+"-stick-card");e&&e.classList.remove("show-slider"),this.Wt(t),this.refresh_finetune_sticks()}Ot(t){const e=t.length;t.forEach((n,i)=>{const s=2*i*Math.PI/e,a=n*Math.cos(s),r=n*Math.sin(s),o=Math.max(-1,Math.min(1,a)),c=Math.max(-1,Math.min(1,r)),l=Math.sqrt(o*o+c*c);t[i]=l})}gt(t){console.log(`Resetting circularity slider for ${t} stick`);const e=document.getElementById(t+"CircularitySlider");e&&(e.value=0),this.dt(t,0),this.J[t]=!1,this.Ct(t),this.clearCircularity(),this.ct(),this.refresh_finetune_sticks()}qt(t){return!(!t||!Array.isArray(t))&&t.every(t=>0!==t)}rt(){Object.entries(q).forEach(([t,e])=>{if(this.J[t])this.Wt(t);else{this.Ct(t);const n=this.qt(this[e.circDataName]),i=document.getElementById(t+"ErrorSlackBtn");i&&(i.disabled=!n,n?(i.classList.add("btn-secondary"),i.classList.remove("btn-outline-secondary")):(i.classList.remove("btn-secondary"),i.classList.add("btn-outline-secondary")))}})}bt(t){if(console.log(`Error slack button clicked for ${t} stick`),"circularity"!==this.V)return void console.log("Error slack button only works in circularity mode");const e=document.getElementById(t+"-stick-card");e&&e.classList.toggle("show-slider")}yt(t){console.log(`Error slack undo button clicked for ${t} stick`),this.gt(t)}zt(t,e){const n=document.getElementById(t+"ErrorSlackUndoBtn"),i=document.getElementById(t+"ErrorSlackBtn");n&&(e?n.classList.remove("d-none"):n.classList.add("d-none")),i&&(e?i.classList.add("d-none"):i.classList.remove("d-none"))}Wt(t){this.zt(t,!0)}Ct(t){this.zt(t,!1)}}let H=null;window.finetune_cancel=async function(){console.log("Cancelling finetune changes"),H&&await H.cancel()},window.finetune_save=function(){console.log("Saving finetune changes"),H&&H.save()},window.finetune_quick_calibrate_center=async function(){H.setQuickCalibrating(!0);const{controller:t}=H;await auto_calibrate_stick_centers(t,(t,e)=>{H.setQuickCalibrating(!1)})},window.finetune_quick_calibrate_range=async function(){H.setQuickCalibrating(!0);const{controller:t,ll_data:e,rr_data:n}=H;await calibrate_range(t,{ll_data:e,rr_data:n},(t,e)=>{H.setQuickCalibrating(!1)})};class Y{constructor(t){this.controller=t,this.isRunning=!1,this.intervals=[],this.maxSamples=500,this.animationFrameId=null,this.canvas=document.getElementById("analysisCanvas"),this.ctx=this.canvas?this.canvas.getContext("2d"):null,this.lastTimestamp=0,this.maxRate=0}open(){const t=document.getElementById("inputAnalysisModal");t&&bootstrap.Modal.getOrCreateInstance(t).show(),this.resetStats(),this.renderGraph()}close(){this.stop();const t=document.getElementById("inputAnalysisModal");if(t){const e=bootstrap.Modal.getInstance(t);e&&e.hide()}}toggle(){this.isRunning?this.stop():this.start()}start(){this.isRunning=!0,this.resetStats();const t=document.getElementById("btn-start-analysis"),e=document.getElementById("btn-analysis-text");t&&(t.classList.remove("btn-glow-primary"),t.classList.add("btn-glow-danger"),e?e.textContent=p("Stop Test"):t.innerHTML='<i class="fas fa-stop me-2"></i> '+p("Stop Test"));const n=document.getElementById("analysis-overlay");n&&(n.style.display="none"),this.Gt()}stop(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null);const t=document.getElementById("btn-start-analysis"),e=document.getElementById("btn-analysis-text");t&&(t.classList.remove("btn-glow-danger"),t.classList.add("btn-glow-primary"),e?e.textContent=p("Start Test"):t.innerHTML='<i class="fas fa-play me-2"></i> '+p("Start Test"))}resetStats(){this.intervals=[],this.lastTimestamp=0,this.maxRate=0;const t={rate:document.getElementById("stat-polling-rate"),max:document.getElementById("stat-max-rate"),lat:document.getElementById("stat-latency"),jit:document.getElementById("stat-jitter")};t.rate&&(t.rate.innerText="0 Hz"),t.max&&(t.max.innerText="0"),t.lat&&(t.lat.innerText="0.00 ms"),t.jit&&(t.jit.innerText="0.00 ms")}handleInput(t){if(!this.isRunning)return;if(0===this.lastTimestamp)return void(this.lastTimestamp=t);const e=t-this.lastTimestamp;this.lastTimestamp=t,e>1e3||(this.intervals.push(e),this.intervals.length>this.maxSamples&&this.intervals.shift())}Gt(){this.isRunning&&(this.updateStats(),this.renderGraph(),this.animationFrameId=requestAnimationFrame(()=>this.Gt()))}updateStats(){if(10>this.intervals.length)return;const t=Math.min(this.intervals.length,100),e=this.intervals.slice(-t),n=e.reduce((t,e)=>t+e,0)/e.length,i=n>0?1e3/n:0;i>this.maxRate&&(this.maxRate=i);const s=e.map(t=>Math.pow(t-n,2)).reduce((t,e)=>t+e,0)/e.length,a=Math.sqrt(s),r={rate:document.getElementById("stat-polling-rate"),max:document.getElementById("stat-max-rate"),lat:document.getElementById("stat-latency"),jit:document.getElementById("stat-jitter")};r.rate&&(r.rate.innerText=Math.round(i)+" Hz"),r.max&&(r.max.innerText=""+Math.round(this.maxRate)),r.lat&&(r.lat.innerText=n.toFixed(2)+" ms"),r.jit&&(r.jit.innerText=a.toFixed(3)+" ms")}renderGraph(){if(!this.ctx||!this.canvas)return;const t=this.canvas.parentElement.clientWidth,e=this.canvas.parentElement.clientHeight;this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e);const n=this.ctx;if(n.clearRect(0,0,t,e),2>this.intervals.length)return;n.strokeStyle="#00f0f0",n.lineWidth=2,n.lineJoin="round",n.beginPath();const i=this.intervals.slice(-t/2),s=Math.max(...i),a=Math.min(...i),r=Math.max(s-a,4),o=t/(i.length-1);i.forEach((t,i)=>{const s=i*o,c=.1*e,l=e-c-(t-a)/r*(e-2*c);0===i?n.moveTo(s,l):n.lineTo(s,l)}),n.stroke()}}let J=null;const X={disable_btn:0,last_disable_btn:0,shownRangeCalibrationWarning:!1,lang_orig_text:{},lang_cur:{},lang_disabled:!0,lang_cur_direction:"ltr",gj:0,gu:0},Q=Array(D),Z=Array(D);let K=null;const tt={lx_lbl:null,ly_lbl:null,rx_lbl:null,ry_lbl:null,stickCanvas:null,l2_progress:null,r2_progress:null};function gboot(){async function t(){tt.lx_lbl=document.getElementById("lx-lbl"),tt.ly_lbl=document.getElementById("ly-lbl"),tt.rx_lbl=document.getElementById("rx-lbl"),tt.ry_lbl=document.getElementById("ry-lbl"),tt.stickCanvas=document.getElementById("stickCanvas"),tt.l2_progress=document.getElementById("l2-progress"),tt.r2_progress=document.getElementById("r2-progress"),window.addEventListener("error",t=>{console.error(t.error?.stack||t.message),xt(t.error?.message||t.message)}),window.addEventListener("unhandledrejection",async t=>{console.error("Unhandled rejection:",t.reason?.stack||t.reason),Mt();let e="An unexpected error occurred";if(t.reason){t.reason.message?e="<strong>Error:</strong> "+t.reason.message:"string"==typeof t.reason&&(e="<strong>Error:</strong> "+t.reason);let n="";t.reason.stack&&(n+="<strong>Main Error Stack:</strong><br>"+t.reason.stack.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;"));let i=t.reason,s=0;for(;i?.cause&&5>s;)s++,i=i.cause,i.stack&&(n&&(n+="<br><br>"),n+=`<strong>Cause ${s} Stack:</strong><br>${i.stack.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;")}`);n&&(e+=`\n            <br>\n            <details style="margin-top: 0px;">\n              <summary style="cursor: pointer; color: #666;">Details</summary>\n              <div style="font-family: monospace; font-size: 0.85em; margin-top: 8px; padding: 8px; background-color: #f8f9fa; border-radius: 4px; overflow-x: auto;">\n                ${n}\n              </div>\n            </details>\n          `)}Rt(e,"danger"),t.preventDefault()}),await async function(){try{const t=await async function(t){if(window.BUNDLED_ASSETS&&window.BUNDLED_ASSETS.svg){const e=window.BUNDLED_ASSETS.svg[t];if(e)return e}try{const e=await fetch("assets/"+t);if(!e.ok)throw Error(`Failed to load SVG asset: ${t} (${e.status})`);return await e.text()}catch(t){throw console.error(t),t}}("icons.svg"),e=document.createElement("div");e.innerHTML=t,document.body.prepend(e);const n=["faq-modal","popup-modal","finetune-modal","calib-center-modal","auto-calib-center-modal","range-modal","edge-progress-modal","edge-modal","input-analysis-modal"].map(t=>async function(t){if(B.has(t))return B.get(t);if(window.BUNDLED_ASSETS&&window.BUNDLED_ASSETS.templates){const e=window.BUNDLED_ASSETS.templates[t];if(e)return B.set(t,e),e}const e=t.includes(".")?"templates/"+t:`templates/${t}.html`;try{const n=await fetch(e);if(!n.ok)throw Error(`Failed to load template: ${t} (${n.status})`);const i=await n.text();return B.set(t,i),i}catch(t){throw console.error(t),t}}(t)),i=await Promise.all(n),s=document.createElement("div");s.id="modals-container",s.innerHTML=i.join(""),document.body.appendChild(s)}catch(t){console.error("Error loading templates:",t)}}(),c(X),function(){f=X,m=vt,w=ot;let t=0;const e=document.querySelectorAll(".ds-i18n");for(const n of e)0===n.id.length&&(n.id="ds-i18n-"+t++),f.lang_orig_text[n.id]=n.innerHTML;f.lang_orig_text[".title"]=document.title;const n=new URLSearchParams(window.location.search).get("lang"),i=u("force_lang");if(n&&d[n])g(n,!0).catch(t=>{console.error("Failed to set language from URL:",t)});else if(null!=i)g(i,!0).catch(t=>{console.error("Failed to set forced language:",t)});else{const t=navigator.language.replace("-","_").toLowerCase(),e=d[t];e&&(o("lang_init",{l:t}),y(e.file,t,e.direction).catch(t=>{console.error("Failed to load initial language:",t)}))}}(),document.querySelectorAll("input[name='displayMode']").forEach(t=>{t.addEventListener("change",mt)});const t=document.getElementById("edgeModalDontShowAgain");t&&t.addEventListener("change",function(){localStorage.setItem("edgeModalDontShowAgain",this.checked.toString())});const e=document.getElementById("ledColorPicker");e&&e.addEventListener("input",function(){const t=this.value,e=parseInt(t.slice(1,3),16),n=parseInt(t.slice(3,5),16),i=parseInt(t.slice(5,7),16);K&&K.currentController&&K.currentController.setLightbarColor(e,n,i)})}if(X.gu=crypto.randomUUID(),"loading"===document.readyState?window.addEventListener("DOMContentLoaded",t):t(),!("hid"in navigator))return et("offlinebar",!1),et("onlinebar",!1),void et("missinghid",!0);et("offlinebar",!0),navigator.hid.addEventListener("disconnect",st)}function et(t,e){const n=document.getElementById(t);n&&(n.style.display=e?"block":"none")}function nt(t,e){const n=document.getElementById(t);n&&(n.style.display=e?"":"none")}async function it({data:t,device:e}){try{if(!K||K.isConnected())return void(e.oninputreport=null);if(63!=t.byteLength)return It(p("The device is connected via Bluetooth. Disconnect and reconnect using a USB cable instead.")),void await disconnect();function n({showInfo:t,showFinetune:e,showInfoTab:n,showFourStepCalib:i,showQuickCalib:s}){nt("infoshowall",t),nt("ds5finetune",e),nt("info-tab",n),nt("four-step-center-calib",i),nt("quick-center-calib",s)}let s=null,a=null;try{s=I.createControllerInstance(e),K.setControllerInstance(s),a=await s.getInfo(),s.initializeCurrentOutputState&&await s.initializeCurrentOutputState()}catch(u){const d=e?`${p("Connected invalid device")}: ${i(e.vendorId)}:${i(e.productId)}`:p("Failed to connect to device");throw Error(d,{cause:u})}if(!a?.ok)throw a&&console.error(JSON.stringify(a,null,2)),Error(`${p("Connected invalid device")}: ${p("Error")}  1`,{cause:a?.error});n(I.getUIConfig(e.productId)),console.log("Setting input report handler."),e.oninputreport=K.getInputHandler();const r=I.getDeviceName(e.productId);document.getElementById("devname").textContent=r+" ("+i(e.vendorId)+":"+i(e.productId)+")",et("offlinebar",!1),et("onlinebar",!0),et("mainmenu",!0),nt("resetBtn",!0);const c=document.getElementById("d-nvstatus");c&&(c.textContent=p("Unknown"));const l=document.querySelector("#controller-tab");l&&bootstrap.Tab.getOrCreateInstance(l).show();const h=s.getModel();if(await async function(t){const e=document.getElementById("controller-svg-placeholder");if(!e)return;let n,i;if("DS4"===t)n="dualshock-controller.svg";else{if("DS5"!==t&&"DS5_Edge"!==t)throw Error("Unknown controller model: "+t);n="dualsense-controller.svg"}if(window.BUNDLED_ASSETS&&window.BUNDLED_ASSETS.svg&&window.BUNDLED_ASSETS.svg[n])i=window.BUNDLED_ASSETS.svg[n];else{const t=await fetch("assets/"+n);if(!t.ok)throw Error("Failed to load controller SVG: "+n);i=await t.text()}e.innerHTML=i;bt(document.getElementById("Controller"),"#7ecbff"),["Button_outlines","Button_outlines_behind","L3_outline","R3_outline","Trackpad_outline"].forEach(t=>{bt(document.getElementById(t),"#3399cc")})}(h),function(t){const e=document.getElementById("digital-buttons-container");if(!e)return;e.innerHTML="";const n={triangle:'<i class="fas fa-play fa-rotate-270" style="font-size: 0.8em; margin-left: 2px;"></i>',circle:'<i class="far fa-circle"></i>',cross:'<i class="fas fa-times"></i>',square:'<i class="far fa-square"></i>',l1:"L1",r1:"R1",l3:"L3",r3:"R3",up:'<i class="fas fa-arrow-up"></i>',down:'<i class="fas fa-arrow-down"></i>',left:'<i class="fas fa-arrow-left"></i>',right:'<i class="fas fa-arrow-right"></i>',ps:'<i class="fab fa-playstation"></i>',create:'<i class="fas fa-share-square" style="font-size: 0.9em;"></i>',options:'<i class="fas fa-bars"></i>',touchpad:'<i class="fas fa-mouse-pointer"></i>',mute:'<i class="fas fa-microphone-slash"></i>'},i=Object.keys(n);for(const s of t)if(i.includes(s.name)){const t=p(s.name),i=n[s.name],a=document.createElement("span");a.id="indicator-"+s.name,a.className="btn-indicator",a.setAttribute("title",t),a.innerHTML=i,e.appendChild(a)}Array.from(e.querySelectorAll("[title]")).map(function(t){if(!bootstrap.Tooltip.getInstance(t))return new bootstrap.Tooltip(t)})}(K.getInputConfig().buttonMap),"DS5_Edge"==h&&a?.pending_reboot)return It(p("A reboot is needed to continue using this DualSense Edge. Please disconnect and reconnect your controller.")),void await disconnect();Ct(a.infoItems),a.nv&&(at(a.nv),!1===a.nv.locked&&await nvslock()),"number"==typeof a.disable_bits&&a.disable_bits&&(X.disable_btn|=a.disable_bits),0!=X.disable_btn&&_t(),"DS4"==h&&a?.rare&&xt("Wow, this is a rare/weird controller! Please write me an email at ds4@the.al or contact me on Discord (the_al)"),"DS5_Edge"==h&&function(){if("true"===localStorage.getItem("edgeModalDontShowAgain"))return;o("edge_modal");const t=document.getElementById("edgeModal");t&&bootstrap.Modal.getOrCreateInstance(t).show()}()}catch(f){throw await disconnect(),f}finally{const w=document.getElementById("btnconnect"),m=document.getElementById("connectspinner");w&&(w.disabled=!1),m&&(m.style.display="none")}}async function disconnect(){o("disconnect"),K?.isConnected()?(X.gj=0,X.disable_btn=0,_t(),await K.disconnect(),K=null,Mt(),et("offlinebar",!0),et("onlinebar",!1),et("mainmenu",!1)):K=null}async function st(t){o("disconnected"),console.log("Disconnected: "+t.device.productName),await disconnect()}function at(t){if(!t?.status)throw Error("Invalid NVS status data",{cause:t?.error});const e=document.getElementById("d-nvstatus");if(e)switch(t.status){case"locked":e.innerHTML="<font color='green'>"+p("locked")+"</font>";break;case"unlocked":e.innerHTML="<font color='red'>"+p("unlocked")+"</font>";break;case"pending_reboot":const n=void 0!==t.raw?"0x"+s(t.raw):(t.code??"")+"";e.innerHTML="<font color='purple'>unk "+n+"</font>";break;case"unknown":const i="ds5"===t.device&&void 0!==t.raw?"0x"+s(t.raw):(t.code??"")+"";e.innerHTML="<font color='purple'>unk "+i+"</font>";break;case"error":e.innerHTML="<font color='red'>"+p("error")+"</font>"}}function rt(t){const e=document.getElementById("dsedge-progress");e&&(e.style.width=t+"%")}function ot(){}function ct(){Q.fill(0),Z.fill(0)}function lt(){if(!K)return;const t=tt.stickCanvas;if(!t)return;const n=t.getContext("2d"),i=t.width;n.clearRect(0,0,t.width,t.height);const{left:{x:s,y:a},right:{x:r,y:o}}=K.button_states.sticks,c=ut(),l=ht();A(n,80,75,60,s,a,{circularity_data:l?Q:null,enable_zoom_center:c}),A(n,i-80,75,60,r,o,{circularity_data:l?Z:null,enable_zoom_center:c});const h=c?3:2;tt.lx_lbl&&(tt.lx_lbl.textContent=e(s,h)),tt.ly_lbl&&(tt.ly_lbl.textContent=e(a,h)),tt.rx_lbl&&(tt.rx_lbl.textContent=e(r,h)),tt.ry_lbl&&(tt.ry_lbl.textContent=e(o,h));try{const t=K.getModel();let e,n,i,c,l,h;if("DS4"===t){const t=25,u=295.63,d=461.03,f=662.06,w=419.78;e=u+s*t,n=d+a*t,i=f+r*t,c=w+o*t,l=`translate(${e-u},${n-d})`,h=`translate(${i-f},${c-w})`}else if("DS5"===t||"DS5_Edge"===t){const t=25,u=295.63,d=461.03,f=662.06,w=419.78;e=u+s*t,n=d+a*t,i=f+r*t,c=w+o*t,l=`translate(${e-u},${n-d}) scale(0.70)`,h=`translate(${i-f},${c-w}) scale(0.70)`}if(l){const t=document.querySelector("g#L3");t&&t.setAttribute("transform",l);const e=document.querySelector("g#R3");e&&e.setAttribute("transform",h)}}catch(t){}}const ht=()=>document.getElementById("checkCircularityMode")?.checked,ut=()=>document.getElementById("centerZoomMode")?.checked;function dt(){ct(),lt()}function ft(){const t=document.getElementById("centerZoomMode");t&&(t.checked=!0),dt()}function wt(){const t=document.getElementById("checkCircularityMode");t&&(t.checked=!0),dt()}const mt=()=>dt(),gt=(()=>{let t=null;return function(e){e.sticks&&(t||(lt(),t=setTimeout(()=>{t=null,lt()},20)))}})();function bt(t,e){t&&t.querySelectorAll("path,rect,circle,ellipse,line,polyline,polygon").forEach(t=>{t.style.fill=e,t.style.stroke=e})}let pt,yt=!1;function kt({changes:t,inputConfig:e,touchPoints:n,batteryStatus:i}){var s;(function(){const t=document.getElementById("inputAnalysisModal");return t&&t.classList.contains("show")})()&&(s=performance.now(),J&&J.handleInput(s));const{buttonMap:a}=e;switch(function(){const t=document.getElementById("mainTabs"),e=t?.querySelector(".nav-link.active");return e?.id||"controller-tab"}()){case"controller-tab":!function(t,e,n){const{left:i,right:s}=t||{};for(const[t,a]of[[i,e],[s,n]]){if(!t)return;const{x:e,y:n}=t,i=Math.sqrt(e*e+n*n),s=(parseInt(Math.round(48*Math.atan2(n,e)/2/Math.PI))+48)%48,r=a[s]??0;a[s]=Math.max(r,i)}}(t.sticks,Q,Z),H?function(t){H&&(H.refresh_finetune_sticks(),H.handleModeSwitching(t),H.handleStickSwitching(t),H.handleDpadAdjustment(t))}(t):((t=>{gt(t)})(t),function(t,e){if(t&&0!==Object.keys(t).length){for(const e of["l2","r2"]){const n=e+"_analog";if(t.hasOwnProperty(n)){const i=t[n],s=Math.round(i/255*100),a=("l2"===e?tt.l2_progress:tt.r2_progress)||document.getElementById(e+"-progress");a&&(a.style.width=s+"%",a.textContent=s+"%");const r=l("white","#FFFFFF",i/255),o=e.toUpperCase()+"_infill",c=document.getElementById(o);bt(c,r);const h=document.getElementById(e.toUpperCase()+"_outline");i>10?(c?.classList.add("pressed-glow"),h?.classList.add("pressed-glow")):(c?.classList.remove("pressed-glow"),h?.classList.remove("pressed-glow"));const u=document.getElementById(e.toUpperCase()+"_percentage");u&&(u.textContent=s+" %",u.setAttribute("opacity",s>0?"1":"0"),u.setAttribute("fill",35>s?"#1a237e":"white"))}}for(const e of["up","right","down","left"])if(t.hasOwnProperty(e)){const n=t[e],i=document.getElementById(e.charAt(0).toUpperCase()+e.slice(1)+"_infill");i&&(n?i.classList.add("pressed-glow"):i.classList.remove("pressed-glow"));const s=document.getElementById("indicator-"+e);s&&(n?s.classList.add("pressed"):s.classList.remove("pressed"))}for(const n of e)if(!["up","right","down","left"].includes(n.name)&&t.hasOwnProperty(n.name)){const e=t[n.name];if(n.svg){const t=document.getElementById(n.svg+"_infill");t&&(e?t.classList.add("pressed-glow"):t.classList.remove("pressed-glow"))}const i=document.getElementById("indicator-"+n.name);i&&(e?i.classList.add("pressed"):i.classList.remove("pressed"))}}}(t,a),function(t){const e=t.some(t=>t.active);if(!e&&!yt)return;const n=document.getElementById("controller-svg"),i=n?.querySelector("g#Trackpad_infill");if(i){if(i.querySelectorAll("circle.ds-touch").forEach(t=>t.remove()),yt=e,!pt){const t=i.querySelector("path");t&&(pt=t.getBBox())}pt&&t.forEach((t,e)=>{if(!t.active)return;const n=.05*pt.width,s=pt.x+n+t.x/1920*(pt.width-2*n),a=pt.y+n+t.y/943*(pt.height-2*n),r=document.createElementNS("http://www.w3.org/2000/svg","circle");r.setAttribute("class","ds-touch"),r.setAttribute("cx",s),r.setAttribute("cy",a),r.setAttribute("r",n),r.setAttribute("fill",0===e?"#2196f3":"#e91e63"),r.setAttribute("fill-opacity","0.5"),r.setAttribute("stroke","#3399cc"),r.setAttribute("stroke-width","4"),i.appendChild(r)})}}(n),function(t){if(!t.sticks||X.shownRangeCalibrationWarning)return;const{left:e,right:n}=t.sticks,i=[e,n].some(({x:t,y:e})=>Math.abs(t)+Math.abs(e)==2),s=document.querySelectorAll(".modal.show").length>0;!i||X.shownRangeCalibrationWarning||s||(X.shownRangeCalibrationWarning=!0,xt(p("Range calibration appears to have failed. Please try again and make sure you rotate the sticks.")))}(t));break;case"tests-tab":!function(){const t=function(){const t=document.getElementById("tests-list"),e=t?.querySelector(".list-group-item.active");return e?.id||"haptic-test-tab"}();"haptic-test-tab"===t?(K.button_states.l2_analog,K.button_states.r2_analog):console.log("Unknown test tab:",t)}()}!function({bat_txt:t,changed:e}){if(e){const e=document.getElementById("d-bat");e&&(e.innerHTML=t)}}(i)}function _t(){const{disable_btn:t,last_disable_btn:e}=X;if(t!=e){if(0==t)return document.querySelectorAll(".ds-btn").forEach(t=>t.disabled=!1),void(X.last_disable_btn=0);document.querySelectorAll(".ds-btn").forEach(t=>t.disabled=!0),1&t&&!(1&e)?xt(p("The device appears to be a clone. All calibration functionality is disabled.")):2&t&&!(2&e)&&xt(p("This DualSense controller has outdated firmware.")+"<br>"+p("Please update the firmware and try again."),!0),X.last_disable_btn=t}}async function vt(){if(!K)return;const{infoItems:t}=await K.getDeviceInfo();Ct(t)}function St(t){at(t)}async function nvslock(){return await K.nvsLock()}function Mt(){document.querySelectorAll(".modal.show").forEach(t=>{const e=bootstrap.Modal.getInstance(t);e&&e.hide()})}function Ct(t){const e=document.getElementById("fwinfo");e&&(e.innerHTML="");const n=document.getElementById("fwinfoextra-hw");n&&(n.innerHTML="");const i=document.getElementById("fwinfoextra-fw");i&&(i.innerHTML="");const s=document.getElementById("d-board");s&&(s.textContent=""),Array.isArray(t)&&t.forEach(({key:t,value:e,addInfoIcon:n,severity:i,isExtra:a,cat:r})=>{if(!t)return;"Board Model"===p(t)&&s&&(s.textContent=e);let o=(e??"")+"";"board"===n?o+='&nbsp;<a class="link-body-emphasis" href="#" onclick="board_model_info()"><svg class="bi" width="1.3em" height="1.3em"><use xlink:href="#info"/></svg></a>':"color"===n&&(o+='&nbsp;<a class="link-body-emphasis" href="#" onclick="edge_color_info()"><svg class="bi" width="1.3em" height="1.3em"><use xlink:href="#info"/></svg></a>'),i&&(o=`<font color='${{danger:"red",success:"green"}[i]||"black"}'><b>${o}</b></font>`),a?Et(t,o,r||"hw"):function(t,e,n){const i='<dt class="text-muted col-6">'+t+'</dt><dd class="col-6" style="text-align: right;">'+e+"</dd>",s=document.getElementById("fwinfo");s&&(s.innerHTML+=i),Et(t,e,n)}(t,o,r||"hw")})}function Et(t,e,n){const i='<dt class="text-muted col-sm-4 col-md-6 col-xl-5">'+t+'</dt><dd class="col-sm-8 col-md-6 col-xl-7" style="text-align: right;">'+e+"</dd>",s=document.getElementById("fwinfoextra-"+n);s&&(s.innerHTML+=i)}function xt(t,e=!1){const n=document.getElementById("popupBody");if(!n)return;e?n.innerHTML=t:n.textContent=t;const i=document.getElementById("popupModal");i&&bootstrap.Modal.getOrCreateInstance(i).show()}let Ft=0;function Rt(t,e="info",n=0,i=!0){const s=document.getElementById("alert-container");if(!s)return console.error("Alert container not found"),null;const a="alert-"+ ++Ft,r=document.createElement("div");return r.id=a,r.className=`alert alert-${e} alert-dismissible fade show`,r.setAttribute("role","alert"),r.innerHTML=`\n    ${t}\n    ${i?'<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>':""}\n  `,s.appendChild(r),n>0&&setTimeout(()=>{!function(t){const e=document.getElementById(t);e&&new bootstrap.Alert(e).close()}(a)},n),a}function Tt(t,e=1500){return Rt(t,"success",e,!1)}function It(t,e=5e3){return Rt(t,"info",e,!1)}window.gboot=gboot,window.connect=async function(){X.gj=crypto.randomUUID(),c(X),K=function(t={}){const e=new k(t);return e.setHasChangesToWrite(!1),e}({handleNvStatusUpdate:St}),K.setInputHandler(kt),o("begin"),function(){ct();const t=document.getElementById("normalMode");t&&(t.checked=!0),lt()}(),function(){const t=document.getElementById("alert-container");t&&t.querySelectorAll(".alert").forEach(t=>{new bootstrap.Alert(t).close()})}(),await t(200);try{const e=document.getElementById("btnconnect"),n=document.getElementById("connectspinner");e.disabled=!0,n.style.display="inline-block",await t(100);const i={filters:I.getSupportedModels()};let s=await navigator.hid.getDevices();if(0==s.length&&(s=await navigator.hid.requestDevice(i)),0==s.length)return e.disabled=!1,n.style.display="none",void await disconnect();if(s.length>1)return It(p("Please connect only one controller at time.")),e.disabled=!1,n.style.display="none",void await disconnect();const[a]=s;a.opened&&(console.log("Device already opened, closing it before re-opening."),await a.close(),await t(500)),await a.open(),o("connect",{p:a.productId,v:a.vendorId}),a.oninputreport=it}catch(t){throw document.getElementById("btnconnect").disabled=!1,document.getElementById("connectspinner").style.display="none",await disconnect(),t}},window.disconnect=function(){disconnect().catch(t=>{throw Error("Failed to disconnect",{cause:t})})},window.show_faq_modal=function(){o("faq_modal");const t=document.getElementById("faqModal");t&&bootstrap.Modal.getOrCreateInstance(t).show()},window.show_info_tab=function(){o("info_modal");const t=document.getElementById("info-tab");t&&bootstrap.Tab.getOrCreateInstance(t).show()},window.calibrate_range=()=>calibrate_range(K,{ll_data:Q,rr_data:Z},(t,e)=>{t&&(dt(),Tt(e),wt(),X.shownRangeCalibrationWarning=!1)}),window.calibrate_stick_centers=()=>async function(t,e=null){P=new $(t,e),await P.open()}(K,(t,e)=>{t&&(dt(),Tt(e),ft())}),window.auto_calibrate_stick_centers=()=>auto_calibrate_stick_centers(K,(t,e)=>{t&&(dt(),Tt(e),ft())}),window.ds5_finetune=()=>async function(t,e,n=null){H=new G,await H.init(t,e,n)}(K,{ll_data:Q,rr_data:Z,clear_circularity:ct},t=>t&&wt()),window.flash_all_changes=async function(){const t="DS5_Edge"==K.getModel(),e=t?rt:null,n=document.getElementById("edgeProgressModal"),i=t&&n?bootstrap.Modal.getOrCreateInstance(n):null;i&&i.show();const s=await K.flash(e);i&&i.hide(),s?.success&&(s.isHtml?xt(s.message,s.isHtml):Tt(s.message))},window.reboot_controller=async function(){await K.reset()},window.refresh_nvstatus=async function(){return K.isConnected()?await K.queryNvStatus():null},window.nvsunlock=async function(){await K.nvsUnlock()},window.nvslock=nvslock,window.show_donate_modal=function(){o("donate_modal");const t=document.getElementById("donateModal");t&&bootstrap.Modal.getOrCreateInstance(t).show()},window.board_model_info=function(){o("bm_info");const t=p("This feature is experimental."),e=p("Please let me know if the board model of your controller is not detected correctly.");xt(p("Board model detection thanks to")+' <a href="https://battlebeavercustoms.com/">Battle Beaver Customs</a>.<br><br>'+t+" "+e,!0)},window.edge_color_info=function(){o("cm_info"),xt(p("Color detection thanks to")+" romek77 from Poland.",!0)},window.test_vibration=(t=150)=>{console.log("Testing vibration..."),K.setVibration({heavyLeft:255,lightRight:255,duration:t})},window.test_led=t=>{console.log("Testing LED: "+t),"red"===t&&K.currentController.setLightbarColor(255,0,0),"green"===t&&K.currentController.setLightbarColor(0,255,0),"blue"===t&&K.currentController.setLightbarColor(0,0,255),"off"===t&&K.currentController.setLightbarColor(0,0,0)},window.test_trigger=(t,e)=>{console.log(`Testing trigger ${t}: ${e}`);const n={left:"left"===t?e:"off",right:"right"===t?e:"off"};K.setAdaptiveTriggerPreset(n)},window.show_input_analysis_modal=()=>function(t){J||(J=new Y(t)),J.open()}(K),window.toggle_input_analysis=function(){J&&J.toggle()},window.stop_input_analysis=function(){J&&J.stop()},gboot();
